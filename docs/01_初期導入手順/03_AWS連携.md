# AWSã§æœ¬ç•ªå…¬é–‹ã™ã‚‹

## 1. **AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**ï¼ˆæ³•äººåã¯ãƒ­ãƒ¼ãƒå­—ã§ç™»éŒ²ï¼‰
## 2. **Route 53ã§ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—**ï¼ˆä¾‹ï¼š`dolcos-calc.com`ï¼‰
### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—1ï¼šRoute 53 ã‚’é–‹ã

AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§
æ¤œç´¢ãƒãƒ¼ã« `Route 53` ã¨å…¥åŠ› â†’ é–‹ã

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²ã€ã¸é€²ã‚€

å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€Œ**ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²**ã€
â†’ ã€Œ**ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ç™»éŒ²ã™ã‚‹**ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—3ï¼šæ¤œç´¢

æ¤œç´¢æ¬„ã«

```
dolcos-calc
```

ã¨å…¥åŠ›ã—ã¦æ¤œç´¢ã€‚

ã™ã‚‹ã¨å€™è£œä¸€è¦§ã«ï¼š

| ãƒ‰ãƒ¡ã‚¤ãƒ³            | å¹´é¡         | å‚™è€ƒ               |
| --------------- | ---------- | ---------------- |
| dolcos-calc.com | $15.00 USD | âœ… ç©ºã„ã¦ã„ã‚Œã°ã€Œåˆ©ç”¨å¯èƒ½ã€è¡¨ç¤º |

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—4ï¼šã€Œã‚«ãƒ¼ãƒˆã«è¿½åŠ ã€â†’ã€Œæ¬¡ã¸ã€

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—5ï¼šç™»éŒ²è€…æƒ…å ±ã‚’å…¥åŠ›

| é …ç›®           | è¨­å®šä¾‹                     |
| ------------ | ----------------------- |
| ç™»éŒ²è€…ã‚¿ã‚¤ãƒ—       | Businessï¼ˆæ³•äººï¼‰            |
| Organization | Example Corp.         |
| Contact name | Example Person           |
| Address      | Example Address |
| City         | Kumamoto-shi            |
| State        | Kumamoto                |
| Country      | Japan                   |
| Postal Code  | 860-XXXX                |
| Phone        | +81-XX-xxxx-xxxx        |
| Email        | æ™®æ®µç¢ºèªã§ãã‚‹æ¥­å‹™ç”¨ãƒ¡ãƒ¼ãƒ«           |

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—6ï¼šã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š

| é …ç›®            | è¨­å®š          |
| ------------- | ----------- |
| è‡ªå‹•æ›´æ–°          | âœ… æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰ |
| WHOISãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­· | âœ… æœ‰åŠ¹ã«ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰ |

ï¼ˆâ€» AWSãŒã€ŒAmazon Registrarã€çµŒç”±ã§WHOISæƒ…å ±ã‚’éš ã—ã¦ãã‚Œã¾ã™ï¼‰

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—7ï¼šæ”¯æ‰•ã„ã¨ç™»éŒ²å®Œäº†

* ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
* ã€Œæ³¨æ–‡ã‚’ç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

ã™ã‚‹ã¨ãƒ¡ãƒ¼ãƒ«ãŒå±Šãã¾ã™ğŸ‘‡

> â€œYour domain registration for dolcos-calc.com has been successfully submitted.â€

â³ æ•°åˆ†ã€œ1æ™‚é–“ã§ç™»éŒ²å®Œäº†ã€‚

---

### ğŸªœ ã‚¹ãƒ†ãƒƒãƒ—8ï¼šDNSï¼ˆãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ï¼‰è‡ªå‹•ç”Ÿæˆ

ç™»éŒ²å®Œäº†å¾Œã« Route 53 ã®ã€Œãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã€ä¸€è¦§ã‚’è¦‹ã‚‹ã¨
`dolcos-calc.com` ã®ã‚¾ãƒ¼ãƒ³ãŒè‡ªå‹•ã§ã§ãã¦ã„ã¾ã™ âœ…

ã“ã‚ŒãŒå¾Œã§

* EC2 ã‚„ S3 ã«ç´ã¥ã‘ã‚‹
* HTTPSåŒ– (Letâ€™s Encrypt / ACM)
  ãŸã‚ã®è¨­å®šå ´æ‰€ã«ãªã‚Šã¾ã™ã€‚

---

ğŸ’¡è£œè¶³ï¼š

* è«‹æ±‚ã¯AWSã®æœˆæ¬¡è«‹æ±‚ã«åˆç®—ã•ã‚Œã¾ã™ï¼ˆãƒ‰ãƒ«å»ºã¦ï¼‰
* 1å¹´å˜ä½ã®è‡ªå‹•æ›´æ–°ï¼ˆå–ã‚Šæ¶ˆã—ã‚‚å¯èƒ½ï¼‰

---

## 3. **EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ**
ã‚„ã‚‹ã“ã¨ï¼ˆAWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«å†…ï¼‰ï¼š

1. ã‚µãƒ¼ãƒ“ã‚¹æ¤œç´¢ â†’ ã€ŒEC2ã€
2. ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã€ã‚¯ãƒªãƒƒã‚¯
3. ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šğŸ‘‡

| é …ç›®        | è¨­å®šä¾‹                             | è§£èª¬                                    |
| --------- | ------------------------------- | ------------------------------------- |
| åå‰        | `dolcos-calc-server`            | |
| OS        | Amazon Linux 2023               | |
| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ— | t3.microï¼ˆç„¡æ–™æ ï¼‰                   | |
| ã‚­ãƒ¼ãƒšã‚¢      | æ–°è¦ä½œæˆï¼ˆä¾‹ï¼š`dolcos-key`ï¼‰            | dolcos-key.pemã‚’ãƒ­ãƒ¼ã‚«ãƒ«PCã«ä¿å­˜ |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸     | 20GB ã§OK                        | |
| **VPC**            | `vpc-******** (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)` | ãã®ã¾ã¾ã§OKï¼ˆAWSãŒç”¨æ„ã—ã¦ã„ã‚‹åŸºæœ¬ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰           |
| **ã‚µãƒ–ãƒãƒƒãƒˆ**          | æŒ‡å®šãªã—ï¼ˆã¾ãŸã¯è‡ªå‹•é¸æŠï¼‰                   | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆVPCå†…ã®ã©ã“ã§ã‚‚OKã€‚å¾Œã§Elastic IPã§å›ºå®šå¯ã€‚    |
| **ã‚¢ãƒ™ã‚¤ãƒ©ãƒ“ãƒªãƒ†ã‚£ã‚¾ãƒ¼ãƒ³**    | æŒ‡å®šãªã—                            | è‡ªå‹•ã§é¸ã°ã›ã¦OKï¼ˆ`ap-northeast-1a` ãªã©ãŒé¸ã°ã‚Œã¾ã™ï¼‰ |
| **ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã®è‡ªå‹•å‰²ã‚Šå½“ã¦** | âœ… **æœ‰åŠ¹åŒ–**ï¼ˆé‡è¦ï¼‰                   | ã“ã‚Œã‚’ONã«ã—ãªã„ã¨ã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ï¼             |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**     | ğŸ”§ **æ–°è¦ä½œæˆ** ã—ã¦ä»¥ä¸‹ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ           | SSH(22)ã ã‘ã§ãªãHTTP/HTTPSã‚’è¨±å¯ã—ã¾ã™          |

èµ·å‹•å¾Œã€ã€Œãƒ‘ãƒ–ãƒªãƒƒã‚¯IPv4ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’æ§ãˆã¦ãŠãã¾ã™
ï¼ˆä¾‹ï¼š`18.183.45.22`ï¼‰

ã“ã‚ŒãŒå¾Œã§ `dolcos-calc.com` ã® Aãƒ¬ã‚³ãƒ¼ãƒ‰ã«ç™»éŒ²ã™ã‚‹IPã§ã™ã€‚

---
### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šï¼ˆé‡è¦ï¼‰

#### â‘  ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã€ ã‚’é¸æŠ

æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥ã‚Œã¾ã—ã‚‡ã†ï¼š

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | è¨­å®šä¾‹                                       |
| ----- | ----------------------------------------- |
| åå‰    | `dolcos-calc-sg`                          |
| èª¬æ˜    | Security group for Dolcos Calc web server |

---

#### â‘¡ ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™

| ã‚¿ã‚¤ãƒ—   | ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ãƒãƒ¼ãƒˆç¯„å›² | ã‚½ãƒ¼ã‚¹                   | èª¬æ˜                |
| ----- | ----- | ----- | --------------------- | ----------------- |
| SSH   | TCP   | 22    | ãƒã‚¤IPï¼ˆæ¨å¥¨ï¼‰or 0.0.0.0/0 | SSHãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼ˆå¾Œã§åˆ¶é™å¯ï¼‰   |
| HTTP  | TCP   | 80    | 0.0.0.0/0             | Webã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªç”¨ï¼‰ |
| HTTPS | TCP   | 443   | 0.0.0.0/0             | SSLåŒ–å¾Œã«å¿…è¦          |
| ã‚«ã‚¹ã‚¿ãƒ  TCP | TCP   | 3000   | ãƒã‚¤IP             | Nginxã‚’ã¾ã ç«‹ã¦ãªã„ã®ã§ã€Rails ã‚’ 3000 ã§ç›´æ¥è¦‹ã‚‹ãŸã‚<br>å¾Œã§ Nginx + HTTPS(443) ã«åˆ‡ã‚Šæ›¿ãˆãŸã‚‰ 3000 ã¯é–‰ã˜ã¾ã™ã€‚          |

ğŸ‘‰ ä¸€æ™‚çš„ã«ã¯å…¨ä¸–ç•Œ(0.0.0.0/0)ã§æ§‹ã„ã¾ã›ã‚“ãŒã€
æœ¬é‹ç”¨æ™‚ã¯SSHã ã‘è‡ªåˆ†ã®å›ºå®šIPã«åˆ¶é™ã™ã‚‹ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚

---

#### â‘¢ ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã€Œå…¨ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯ (0.0.0.0/0)ã€ã§OKã§ã™ã€‚
ï¼ˆå¤–éƒ¨ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ï¼‰

---

### ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®šï¼ˆå®¹é‡ï¼‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | æ¨å¥¨å€¤                             |
| ----- | ------------------------------- |
| ã‚µã‚¤ã‚º   | **20 GiB**ï¼ˆæœ€åˆã®8GiBã ã¨ã™ãè¶³ã‚Šãªããªã‚Šã¾ã™ï¼‰ |
| ã‚¿ã‚¤ãƒ—   | gp3 ã®ã¾ã¾ã§OK                      |
| æš—å·åŒ–   | ãªã—ã§OKï¼ˆå¾Œã§åˆ‡ã‚Šæ›¿ãˆå¯ï¼‰                  |

---
## 4. **EC2ã¸ã®åˆå›æ¥ç¶š**

1. PowerShellã§SSHã‚­ãƒ¼ã‚’åˆ©ç”¨ã—ã¦æ¥ç¶š

   ```powershell
   ssh -i C:\Users\xxxxx\.ssh\dolcos-key.pem ec2-user@<IP>
   ```
2. `git`, `docker`, `docker-compose` ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

   ```bash
   # 1ï¸âƒ£ åŸºæœ¬ãƒ„ãƒ¼ãƒ«ã®å°å…¥
   sudo dnf install -y git docker
   # 2ï¸âƒ£ Dockerã‚’èµ·å‹•ãƒ»è‡ªå‹•èµ·å‹•
   sudo systemctl enable --now docker
   # 3ï¸âƒ£ ec2-user ã‚’ docker ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ï¼ˆsudoä¸è¦åŒ–ï¼‰
   sudo usermod -aG docker ec2-user
   # 4ï¸âƒ£ Compose v2 ãƒã‚¤ãƒŠãƒªã‚’æ‰‹å‹•é…ç½®ï¼ˆAL2023æ¨™æº–ãƒ‘ã‚¹ï¼‰
   sudo mkdir -p /usr/libexec/docker/cli-plugins/
   VER=2.27.0    # â† æœ€æ–°ç‰ˆã«æ›´æ–°å¯
   sudo curl -SL "https://github.com/docker/compose/releases/download/v${VER}/docker-compose-linux-$(uname -m)" -o /usr/libexec/docker/cli-plugins/docker-compose
   sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose
   # 5ï¸âƒ£ å‹•ä½œç¢ºèª
   docker --version
   docker compose version
   exit  # â† ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆæ¨©é™åæ˜ ï¼‰
   ```
3. å‹•ä½œç¢ºèª

   ```bash
   docker run --rm hello-world
   ```

---

## 5. **ã‚·ã‚¹ãƒ†ãƒ å®‰å®šåŒ–ï¼ˆSwapã®è¨­å®šï¼‰**

1. ä¸€æ™‚Swapã‚’ä½œæˆï¼ˆãƒ“ãƒ«ãƒ‰ç”¨ï¼‰

   ```bash
   sudo fallocate -l 2G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   free -h
   ```
2. æ°¸ç¶šåŒ–ï¼ˆå†èµ·å‹•ã—ã¦ã‚‚æœ‰åŠ¹ï¼‰

   ```bash
   echo '/swapfile swap swap defaults 0 0' | sudo tee -a /etc/fstab
   ```

---

## 6. **Dockerè¨­å®š**

æœ¬ç•ªç”¨ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

1. **`Dockerfile.prod`** ã‚’ä½œæˆï¼ˆRails + Node + Sass + Bootstrapå¯¾å¿œï¼‰  

   `app\Dockerfile.prod`
   ```dockerfile
   # syntax=docker/dockerfile:1.7
   FROM public.ecr.aws/docker/library/ruby:3.3-slim

   ENV LANG=C.UTF-8 TZ=Asia/Tokyo \
       BUNDLE_JOBS=2 BUNDLE_RETRY=3 \
       RAILS_ENV=production RACK_ENV=production \
       RAILS_LOG_TO_STDOUT=true

   RUN --mount=type=cache,target=/var/cache/apt \
       --mount=type=cache,target=/var/lib/apt/lists \
          apt-get update -y \
    && apt-get install -y --no-install-recommends \
         build-essential libpq-dev pkg-config git curl ca-certificates \
         libyaml-dev libssl-dev zlib1g-dev \
         nodejs npm \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /var/cache/apt/* /tmp/*

   WORKDIR /app

   # å…ˆã«Gemã‚’å…¥ã‚Œã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ã‚‹
   COPY Gemfile Gemfile.lock ./
   RUN gem install bundler -N \
   && bundle config set without 'development test' \
   && bundle config set force_ruby_platform true \
   && bundle install -j2

   # â† Node ä¾å­˜ï¼ˆpackage.jsonï¼‰ãŒã‚ã‚‹ãªã‚‰å…ˆã«å…¥ã‚Œã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åŠ¹ã‹ã›ã‚‹
   #    * package-lock.json ãŒã‚ã‚‹ãªã‚‰ä¸€ç·’ã«COPYã—ã¦ npm ci ã‚’ä½¿ã†ã®ãŒãƒ™ã‚¹ãƒˆ
   COPY package.json package-lock.json* ./
   RUN test -f package.json && (npm ci || npm install) || true

   # node_modules ã‚’ Sass ã®ãƒ­ãƒ¼ãƒ‰ãƒ‘ã‚¹ã«é€šã™
   ENV SASS_PATH=node_modules

   # ã‚¢ãƒ—ãƒªæœ¬ä½“
   COPY . .

   # CSSã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã€bootstrap-icons ã® CSS/ãƒ•ã‚©ãƒ³ãƒˆã‚’ builds é…ä¸‹ã¸ã‚³ãƒ”ãƒ¼
   RUN npm run build:css

   # ãƒ“ãƒ«ãƒ‰æ™‚ã¯ãƒ€ãƒŸãƒ¼ã® SECRET_KEY_BASE ã‚’æ¸¡ã™ï¼ˆå®Ÿè¡Œæ™‚ã¯ .env ã®æœ¬ç‰©ã‚’ä½¿ç”¨ï¼‰
   RUN --mount=type=secret,id=rails_master_key \
       --mount=type=secret,id=db_url \
       sh -lc 'set -eu; \
         RAILS_MASTER_KEY="$(tr -d "\r\n" </run/secrets/rails_master_key)"; \
         DATABASE_URL=postgres://dummy:dummy@localhost:5432/dummy; \
         export RAILS_MASTER_KEY DATABASE_URL; \
         export SECRET_KEY_BASE=dummy; \
         bundle exec rails assets:precompile'

   EXPOSE 3000
   CMD ["bash","-lc","bundle exec rails db:prepare && bundle exec rails server -b 0.0.0.0 -p 3000"]
   ```
2. **`docker-compose.prod.yml`** ã‚’ä½œæˆ

   * `app`ï¼ˆRailsï¼‰
   * `db`ï¼ˆPostgreSQLï¼‰â†’ ã®ã¡ã«S3ã«é€£æºã™ã‚‹ã¨ãå‰Šé™¤ã™ã‚‹  

    `docker-compose.prod.yml`
   ```yaml
    services:
      db:
        image: postgres:16
        environment:
          POSTGRES_USER: ${POSTGRES_USER:-}
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-}
          POSTGRES_DB: ${POSTGRES_DB:-}
        volumes:
          - db-data:/var/lib/postgresql/data
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
          interval: 5s
          timeout: 5s
          retries: 20
        restart: unless-stopped

      app:
        build:
          context: .
          dockerfile: app/Dockerfile.prod
          secrets:
            - rails_master_key
        env_file: .env                      # â† EC2 ã«ä½œã‚‹ .env ã‚’åˆ©ç”¨
        depends_on:
          db:
            condition: service_healthy
        ports:
          - "127.0.0.1:3000:3000"
        environment:
          RAILS_ENV: "production"
          RACK_ENV:  "production"
        secrets:
          - rails_master_key
        command: bash -lc "bundle exec rails db:migrate && bundle exec rails server -b 0.0.0.0 -p 3000"
        restart: unless-stopped
        volumes:
          - ./config/credentials/production.key:/app/config/credentials/production.key:ro

    secrets:
      rails_master_key:
        file: ./config/credentials/production.key

    volumes:
      db-data:
   ```

ã‚³ãƒŸãƒƒãƒˆã‚’å¿˜ã‚Œãšã«ï¼  

---

## 6. **EC2 å´ã§éµã‚’ä½œã‚Šã€GitHub ã«ç™»éŒ²**
1. EC2 å´ã§éµã‚’ä½œã‚Šã€GitHub ã«ç™»éŒ²

   ```bash
   ssh-keygen -t ed25519 -C "ec2-dolcos-calc"    # é€£æ‰“ã§OKï¼ˆãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºä»»æ„ï¼‰
   eval "$(ssh-agent -s)"
   ssh-add ~/.ssh/id_ed25519
   cat ~/.ssh/id_ed25519.pub
   ```
2. è¡¨ç¤ºã•ã‚ŒãŸå…¬é–‹éµï¼ˆ`ssh-ed25519 ...`ï¼‰ã‚’GitHubå´ã«ã‚³ãƒ”ãƒ¼

   * GitHub â†’ å³ä¸Šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« â†’ **Settings** â†’ **SSH and GPG keys** â†’ **New SSH key** â†’ è²¼ã‚Šä»˜ã‘ â†’ ä¿å­˜
3. EC2 å´ã§æ¥ç¶šãƒ†ã‚¹ãƒˆï¼š
   ```bash
   ssh -T git@github.com
   # åˆå›ã¯ "Are you sure..." â†’ yesã€æ¬¡ã« "Hi Koji5!" ãŒå‡ºã‚Œã°OK
   ```
4. SSHã§cloneï¼š
    ```bash
    git clone git@github.com:Koji5/dolcos_calc.git ~/dolcos-calc
    git remote set-url origin git@github.com:Koji5/dolcos_calc.git
    cd ~/dolcos-calc
    ```

   ï¼ˆ2å›ç›®ä»¥é™ã¯ `git pull origin main`ï¼‰

## 7. **ã‚³ãƒ³ãƒ†ãƒŠå´ã®ã‚¢ãƒ—ãƒªè¨­å®š**

1. `.env` ã‚’ä½œæˆ

   ```bash
   cat > .env <<EOF
   RAILS_ENV=production
   POSTGRES_USER=postgres
   POSTGRES_PASSWORD=password
   POSTGRES_DB=dolcos_production
   SECRET_KEY_BASE=$(openssl rand -hex 64)
   DATABASE_URL=postgres://postgres:password@db:5432/dolcos_production
   RAILS_SERVE_STATIC_FILES=true
   EOF
   ```

2. `credentials` ã‚’ç”Ÿæˆ

   ```bash
   # production.key ã‚’æ‰‹å‹•ç”Ÿæˆ
   mkdir -p config/credentials
   umask 177
   printf "%s" "$(openssl rand -hex 16)" > config/credentials/production.key
   chmod 600 config/credentials/production.key
   ## 32 ã¨å‡ºã‚Œã°OK
   wc -c config/credentials/production.key

   # ãã®éµã§ production.yml.enc ã‚’æ–°è¦ä½œæˆ
   ## ãƒ›ã‚¹ãƒˆã§ç’°å¢ƒå¤‰æ•°ã«èª­ã¿è¾¼ã¿ã€exec ã§æ¸¡ã™
   RAILS_MASTER_KEY=$(tr -d '\n' < config/credentials/production.key)
   docker compose -f docker-compose.prod.yml exec -e RAILS_MASTER_KEY="$RAILS_MASTER_KEY" -e EDITOR=true app bash -lc 'bundle exec rails credentials:edit --environment production'
   ## ã‚³ãƒ³ãƒ†ãƒŠ â†’ ãƒ›ã‚¹ãƒˆã¸ .enc ã‚’ã‚³ãƒ”ãƒ¼
   mkdir -p ./config/credentials
   docker compose -f docker-compose.prod.yml cp app:/app/config/credentials/production.yml.enc ./config/credentials/production.yml.enc
   ## Git ã«ãƒ—ãƒƒã‚·ãƒ¥
   git push origin main
   ```

3. ãƒ­ãƒ¼ã‚«ãƒ«ã«åŒã˜ production.key ã‚’ä½œæˆï¼ˆæƒãˆã‚‹ï¼‰

    EC2ã® production.key ã¨åŒã˜å†…å®¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ç½®ãã¾ã™ã€‚  
    Git ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«pullã—ãŸå¾Œã€
    ```powershell
    # ãƒ­ãƒ¼ã‚«ãƒ«PCã§å®Ÿè¡Œï¼ˆEC2â†’ãƒ­ãƒ¼ã‚«ãƒ«ã¸ã‚³ãƒ”ãƒ¼ï¼‰
    cd c:\dev\dolcos_calc
    scp -i "C:\Users\xxxxx\.ssh\dolcos-key.pem" ec2-user@<IP>:/home/ec2-user/dolcos-calc/config/credentials/production.key ./config/credentials/production.key
    icacls ./config/credentials/production.key
    ```
   â€» `config/credentials/production.key` ã¯ Git ç®¡ç†ã—ãªã„ï¼

---

## 8. **ãƒ“ãƒ«ãƒ‰ã¨èµ·å‹•**

```bash
DOCKER_BUILDKIT=1 docker compose -f docker-compose.prod.yml build --no-cache app
docker-compose -f docker-compose.prod.yml up -d
docker-compose -f docker-compose.prod.yml logs -f app
```

âœ… `Listening on 0.0.0.0:3000` ãŒå‡ºãŸã‚‰æˆåŠŸã€‚  
âœ… `http://<EC2ã®IP>:3000` â†’ ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸è¡¨ç¤º

---

## 9. **ãƒ‰ãƒ¡ã‚¤ãƒ³é€£æº**
  Route 53ã«Aãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚
### **Step1  Elastic IPï¼ˆå›ºå®šIPï¼‰å‰²ã‚Šå½“ã¦**

* ***â‘  Elastic IPã‚’æ–°è¦ä½œæˆã™ã‚‹***

  1. AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³
  2. ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œã‚µãƒ¼ãƒ“ã‚¹ã€â†’ **EC2** ã‚’é¸æŠ
  3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œ**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼†ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã€â†’ **Elastic IP** ã‚’ã‚¯ãƒªãƒƒã‚¯
  4. ã€Œ**Elastic IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å‰²ã‚Šå½“ã¦**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  5. å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œ**å‰²ã‚Šå½“ã¦**ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™  
  â†’ æ–°ã—ã„å›ºå®šIPï¼ˆä¾‹ï¼š`13.112.xxx.xxx`ï¼‰ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

* ***â‘¡ Elastic IP ã‚’ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é–¢é€£ä»˜ã‘ã‚‹***
  1. ç™ºè¡Œã•ã‚ŒãŸ Elastic IP ã®ä¸€è¦§ã§ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å…¥ã‚Œã‚‹
  2. ã€Œ**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**ã€â†’ã€Œ**Elastic IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é–¢é€£ä»˜ã‘**ã€ã‚’é¸æŠ
  3. ã€Œ**ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—**ã€ã§ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ã‚’é¸ã¶
  4. ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€æ¬„ã‹ã‚‰ã€ã‚ãªãŸã® EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é¸æŠ
  5. ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¯è‡ªå‹•ã§è£œå®Œã•ã‚Œã‚‹ã®ã§ã€ãã®ã¾ã¾ã€Œ**é–¢é€£ä»˜ã‘**ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™

* ***â‘¢ ç¢ºèª***
  1. EC2 â†’ ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã€ç”»é¢ã‚’é–‹ã
  2. å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯
  3. ä¸‹éƒ¨ã®ã€Œè©³ç´°ã€ã‚¿ãƒ–ã§ã€Œ**Elastic IP**ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

* ***â‘£ æ—§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã®æ‰±ã„***
  1. æ—§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¯è‡ªå‹•çš„ã«ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚  
  1. ä»¥å¾Œã€**æ–°ã—ã„ Elastic IP**ï¼ˆä¾‹ï¼š`13.112.xxx.xxx`ï¼‰ãŒå›ºå®šã®å…¬é–‹ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãªã‚Šã¾ã™ã€‚

### **Step2 Aãƒ¬ã‚³ãƒ¼ãƒ‰è¨­å®š**
* **ğŸªœ æ‰‹é †â‘ ï¼šå‰æç¢ºèª**

  ã¾ãšã€æ¬¡ã®3ç‚¹ã‚’ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

  | é …ç›®                | å†…å®¹                                                                                 |
  | ----------------- | ---------------------------------------------------------------------------------- |
  | âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³            | ã™ã§ã«å–å¾—æ¸ˆã¿ï¼ˆä¾‹ï¼š`example.com`ï¼‰                                                           |
  | âœ… EC2 ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP    | ä¾‹ï¼š`13.112.xxx.xxx`ï¼ˆElastic IP ãªã‚‰å›ºå®šï¼‰                                                |
  | âœ… Route 53 ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ | ãƒ‰ãƒ¡ã‚¤ãƒ³å–å¾—å…ƒãŒ AWS Route 53 ã§ã‚ã‚Œã°è‡ªå‹•ã§ä½œæˆæ¸ˆã¿ã€‚å¤–éƒ¨ï¼ˆãŠåå‰.comç­‰ï¼‰ã®å ´åˆã¯ã€Route 53 å´ã§ã€Œãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã€ã‚’æ–°è¦ä½œæˆã™ã‚‹å¿…è¦ã‚ã‚Šã€‚ |

* **ğŸªœ æ‰‹é †â‘¡ï¼šRoute 53 ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã‚’ç¢ºèªï¼ä½œæˆ**

  1. AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ **Route 53** â†’ **ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³**
  2. ã€Œexample.comã€ãŒãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹ç¢ºèª
    ã€€â†’ ãªã‘ã‚Œã°ã€Œãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã®ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    ã€€ã€€- ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼š`example.com`
    ã€€ã€€- ã‚¿ã‚¤ãƒ—ï¼š**ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³**

  ä½œæˆå¾Œã€**ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒï¼ˆNSï¼‰ãƒ¬ã‚³ãƒ¼ãƒ‰**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

  > ğŸ’¡ å¤–éƒ¨ãƒ¬ã‚¸ã‚¹ãƒˆãƒ©ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å–ã£ãŸå ´åˆ
  > ãƒ‰ãƒ¡ã‚¤ãƒ³ç®¡ç†ç”»é¢ã§ **ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒã‚’ Route53 ã® NS ã«å¤‰æ›´** ã—ã¦ãã ã•ã„ï¼ˆåæ˜ ã¾ã§æ•°æ™‚é–“ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚


* **ğŸªœ æ‰‹é †â‘¢ï¼šAãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ ï¼ˆEC2ã®IPã‚’æŒ‡å®šï¼‰**

  1. Route 53 â†’ å¯¾è±¡ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã‚’é–‹ã
  2. ã€Œãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
  3. ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›ï¼š

    | é …ç›®      | å…¥åŠ›ä¾‹                                           |
    | ------- | --------------------------------------------- |
    | ãƒ¬ã‚³ãƒ¼ãƒ‰å   | ç©ºæ¬„ï¼ˆï¼ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ `example.com`ï¼‰ã¾ãŸã¯ `www`ï¼ˆå¿…è¦ãªã‚‰ä¸¡æ–¹ä½œã‚‹ï¼‰ |
    | ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ— | **A â€“ IPv4ã‚¢ãƒ‰ãƒ¬ã‚¹**                              |
    | å€¤       | `13.112.xxx.xxx`ï¼ˆEC2ã®Elastic IPï¼‰              |
    | TTL     | 300ï¼ˆã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ï¼‰                              |

  > ğŸ’¡ EC2ã®IPã¯å¿…ãš **Elastic IPï¼ˆå›ºå®šIPï¼‰** ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚
  > å†èµ·å‹•ã§å¤‰ã‚ã‚‹ã€Œå‹•çš„ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã€ã ã¨ DNS ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

* **ğŸªœ æ‰‹é †â‘£ï¼šå‹•ä½œç¢ºèª**

  ãƒ­ãƒ¼ã‚«ãƒ«PCã‹ã‚‰ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š

  ```bash
  ping example.com
  ```

  ã¾ãŸã¯

  ```bash
  nslookup example.com
  ```

  çµæœã«EC2ã®IPï¼ˆä¾‹ï¼š13.112.xxx.xxxï¼‰ãŒå‡ºã‚Œã°OKã€‚

  ãã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã§
  ğŸ‘‰ `http://example.com:3000`
  ã‚’é–‹ã„ã¦ã€æ˜¨æ—¥ã®Railsç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚
---
## 10. **HTTPSåŒ–**

æ¬¡ã®3ã‚¹ãƒ†ãƒƒãƒ—ã§ **HTTPSåŒ–ï¼ˆ443ç•ªãƒãƒ¼ãƒˆå¯¾å¿œï¼‰** ã‚’è¡Œã„ã¾ã™ğŸ‘‡

### **ğŸ§­ å…¨ä½“ã®æµã‚Œ**
   | ã‚¹ãƒ†ãƒƒãƒ—                | æ¦‚è¦                                       | å®Ÿè¡Œå ´æ‰€                   |
   | ------------------- | ---------------------------------------- | ---------------------- |
   | **â‘  nginxå°å…¥**       | 80ç•ªãƒ»443ç•ªã‚’å—ã‘ã¦ã€Railsã‚³ãƒ³ãƒ†ãƒŠï¼ˆ3000ç•ªï¼‰ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã™ã‚‹ | EC2ä¸Šï¼ˆãƒ›ã‚¹ãƒˆ or nginxã‚³ãƒ³ãƒ†ãƒŠï¼‰ |
   | **â‘¡ certbotã§è¨¼æ˜æ›¸ç™ºè¡Œ** | Let's Encrypt ã§ç„¡æ–™SSLè¨¼æ˜æ›¸ã‚’å–å¾—ã—ã€nginxã«é©ç”¨     | EC2ä¸Š                   |
   | **â‘¢ nginx.confèª¿æ•´**  | 443ç•ªã§SSLå¯¾å¿œã€HTTP(80)â†’HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ          | EC2ä¸Š                   |
  
  
1. **EC2ã«nginxã‚’å…¥ã‚Œã‚‹**
   ```bash
   sudo dnf update -y
   sudo dnf install -y nginx
   sudo systemctl enable --now nginx
   sudo systemctl status nginx
   ```
   `http://<EC2ã®IP>/` ã«nginxã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšãƒ¼ã‚¸ãŒå‡ºã‚Œã°OKã€‚

2. **nginxã‚’ã€Œ3000 â†’ é€†ãƒ—ãƒ­ã‚­ã‚·ã€åŒ–**

   è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³åã¯ç½®ãæ›ãˆï¼‰ï¼š

   ```bash
   sudo tee /etc/nginx/conf.d/dolcos-calc.conf >/dev/null <<'NGINX'
   server {
     listen 80;
     server_name dolcos-calc.com www.dolcos-calc.com;

     # å¾Œã§certbotãŒã“ã®serverãƒ–ãƒ­ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã¦èªè¨¼/æ›¸æ›ã™ã‚‹
     location / {
       proxy_pass http://127.0.0.1:3000;
       proxy_set_header Host              $host;
       proxy_set_header X-Real-IP         $remote_addr;
       proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       client_max_body_size 20m;
     }
   }
   NGINX
   ```

   ãƒ†ã‚¹ãƒˆï¼†åæ˜ ï¼š

   ```bash
   sudo nginx -t
   sudo systemctl reload nginx
   ```

   > âœ… **Dockerã®ãƒãƒ¼ãƒˆå…¬é–‹ã¯127.0.0.1ã«é™å®š**ã—ã¦ãŠãã¨å®‰å…¨  
   > `docker-compose.prod.yml` ã® `ports` ã‚’ `["127.0.0.1:3000:3000"]` ã«ã—ã¦ãŠãã¨ã€å¤–éƒ¨ã‹ã‚‰3000ç›´å©ãã•ã‚Œã¾ã›ã‚“ï¼ˆå¾Œè¿°ï¼‰ã€‚

3. **certbot ã‚’å°å…¥ï¼ˆLetâ€™s Encryptï¼‰**

   ```bash
   sudo dnf install -y certbot python3-certbot-nginx
   ```

   è¨¼æ˜æ›¸ç™ºè¡Œï¼ˆwwwã‚‚ä½¿ã†ãªã‚‰ä¸¡æ–¹æŒ‡å®šã€‚wwwãŒä¸è¦ãªã‚‰ apex ã®ã¿ã§OKï¼‰ï¼š

   ```bash
   # apexã®ã¿
   sudo certbot --nginx -d dolcos-calc.com
   # apex+wwwï¼ˆwwwã¯Route 53ã§CNAMEã‚’apexã«å‘ã‘ã¦ãŠãã¨å‰ï¼‰
   # sudo certbot --nginx -d dolcos-calc.com -d www.dolcos-calc.com
   ```

   ```bash
   Saving debug log to /var/log/letsencrypt/letsencrypt.log Enter email address (used for urgent renewal and security notices) (Enter 'c' to cancel):
   # Letâ€™s Encryptï¼ˆï¼Certbotï¼‰ãŒåˆå›ã®SSLè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹éš›ã€ç·Šæ€¥é€£çµ¡ç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’èã„ã¦ã„ã¾ã™ã€‚
   # é€šå¸¸ã¯ã‚ãªãŸãŒç®¡ç†ã—ã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¾‹ï¼šsakamoto@example.comï¼‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
   Please read the Terms of Service at https://letsencrypt.org/documents/LE-SA-v1.4-April-2018.pdf. 
   You must agree in order to register with the ACME server at https://acme-v02.api.letsencrypt.org/directory...
   (Y)es/(N)o:
   # Y ã‚’å…¥åŠ›ã—ã¦Enterã€‚
   Would you be willing to share your email address with the Electronic Frontier Foundation (EFF) ... ?
   (Y)es/(N)o:
   # Nï¼ˆã©ã¡ã‚‰ã§ã‚‚OKã§ã™ãŒã€é€šå¸¸ã¯Nï¼‰ã€‚
   ```
   â†’ certbotãŒè‡ªå‹•ã§ `listen 443 ssl;` ã®ã‚µãƒ¼ãƒãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ã¨è¨¼æ˜æ›¸ãƒ‘ã‚¹ã‚’è¿½è¨˜ã—ã¾ã™ã€‚  
   æœ€å¾Œã«ã“ã®ã‚ˆã†ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã‚Œã°æˆåŠŸã§ã™ğŸ‘‡
   ```bash
   Congratulations! You have successfully enabled HTTPS on https://dolcos-calc.com
   ```

   å‹•ä½œç¢ºèªï¼š

   * `https://dolcos-calc.com/` ã§ãƒˆãƒƒãƒ—ãŒå‡ºã‚‹
   * `http://dolcos-calc.com/` ã¯è‡ªå‹•ã§HTTPSã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

4. **3000ç•ªã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ã®å‰Šé™¤**

   #### ğŸ”¥ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ“ä½œæ‰‹é †

   1. AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ **EC2 â†’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**
   2. å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç´ã¥ã SG ã‚’é–‹ã
   3. **ã€Œã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ã€ã‚¿ãƒ– â†’ ç·¨é›†**
   4. ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ï¼š  
      ```
      ã‚¿ã‚¤ãƒ—: ã‚«ã‚¹ã‚¿ãƒ TCP
      ãƒãƒ¼ãƒˆç¯„å›²: 3000
      ã‚½ãƒ¼ã‚¹: 0.0.0.0/0
      ```
   5. ä¿å­˜ï¼ˆã€Œãƒ«ãƒ¼ãƒ«ã‚’ä¿å­˜ã€ï¼‰

   #### âœ… å‰Šé™¤å¾Œã®å‹•ä½œç¢ºèª

   * å‰Šé™¤å¾Œã€å¤–éƒ¨ã‹ã‚‰ï¼š

     ```bash
     curl http://3.104.206.45:3000
     # â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯æ¥ç¶šæ‹’å¦ (OK)
     ```

   * ãã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§ï¼š  
     ğŸ‘‰ `https://dolcos-calc.com/`

## 11. **S3ã¨ã®é€£æº**

### â‘  S3ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚‹

1. ã‚µãƒ¼ãƒ“ã‚¹ â†’ **S3**
2. ã€Œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã€

   * ãƒã‚±ãƒƒãƒˆåï¼šä¾‹ï¼‰`dolcos-calc-prod-assets`
   * ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼šEC2ã¨åŒã˜ï¼ˆä¾‹ï¼š`ap-northeast-1`ï¼‰
   * **ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã¯ã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯ONï¼ˆæ¨å¥¨ï¼‰**
   * ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã¯ä»»æ„ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ãŸã„ãªã‚‰ONï¼‰
   * ä½œæˆ

### â‘¡ IAMã§ãƒ­ãƒ¼ãƒ«ä½œæˆ

1. ã‚µãƒ¼ãƒ“ã‚¹ â†’ **IAM**
2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€Œãƒ­ãƒ¼ãƒ«ã€â†’ã€Œãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã€
3. ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹é¸æŠ â†’ ã€Œ**EC2**ã€ã‚’é¸ã³ã€Œæ¬¡ã¸ã€
4. ã€Œè¨±å¯ãƒãƒªã‚·ãƒ¼ã€ã¯æœªé¸æŠã®ã¾ã¾ã€Œæ¬¡ã¸ã€
5. ã€Œåå‰ã€ç¢ºèªã€ãŠã‚ˆã³ä½œæˆã€

   * ãƒ­ãƒ¼ãƒ«åï¼š`DolcosCalcRole`
   * èª¬æ˜ï¼š`Allow EC2 to access S3 bucket`
   * ã€Œãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã€

### â‘¢ IAMã§ãƒãƒªã‚·ãƒ¼ä½œæˆ

1. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ **ã€Œãƒãƒªã‚·ãƒ¼ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. å³ä¸Šã® **ã€Œãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯  
   â†’ æ–°ã—ã„ç”»é¢ãŒé–‹ãã¾ã™
3. ã€ŒJSONã€ã‚¿ãƒ–ã‚’é¸æŠã—ã¦ã€ä»¥ä¸‹ã‚’è²¼ã‚Šä»˜ã‘ â†’ ã€Œæ¬¡ã¸ã€

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:ListBucket"
          ],
          "Resource": "arn:aws:s3:::dolcos-calc-prod-assets"
        },
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject",
            "s3:PutObjectAcl"
          ],
          "Resource": "arn:aws:s3:::dolcos-calc-prod-assets/*"
        }
      ]
    }
    ```
    `dolcos-calc-prod-assets`ã¯ã€å…ˆã»ã©S3ã§ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆåã§ã™ã€‚
4. ã€Œç¢ºèªã—ã¦ä½œæˆã€ â†’ ã€Œãƒãƒªã‚·ãƒ¼ã®ä½œæˆã€

   * ãƒãƒªã‚·ãƒ¼åï¼š`DolcosCalcS3AccessPolicy`

### â‘£ ä½œã£ãŸãƒãƒªã‚·ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ«ã«ä»˜ã‘ã‚‹

1. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€Œãƒ­ãƒ¼ãƒ«ã€
2. ã•ã£ãä½œã£ãŸãƒ­ãƒ¼ãƒ« `DolcosCalcRole` ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€Œ**è¨±å¯ã‚’è¿½åŠ **ã€ãƒœã‚¿ãƒ³ â†’ ã€Œãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã€
4. æ¤œç´¢æ¬„ã« `DolcosCalcS3AccessPolicy` ã¨å…¥åŠ›
5. ãƒã‚§ãƒƒã‚¯ã—ã¦ã€Œè¨±å¯ã‚’è¿½åŠ ã€

â†’ ã“ã‚Œã§ãƒ­ãƒ¼ãƒ«ã«S3ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒä»˜ãã¾ã—ãŸ âœ…

## â‘¤ EC2ã«ãƒ­ãƒ¼ãƒ«ã‚’ã‚¢ã‚¿ãƒƒãƒ

1. ã‚µãƒ¼ãƒ“ã‚¹ â†’ **EC2**
2. å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é¸æŠ
3. ä¸Šéƒ¨ã®ã€Œ**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ > ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ > IAMãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´**ã€
4. ä½œæˆã—ãŸãƒ­ãƒ¼ãƒ«ï¼ˆä¾‹ï¼š`DolcosCalcRole`ï¼‰ã‚’é¸æŠ â†’ ã€ŒIMAãƒ­ãƒ¼ãƒ«ã®æ›´æ–°ã€

### â‘¥ EC2ã§ç¢ºèª

   * SSHã§EC2ã«å…¥ã‚Šã€æ¬¡ã‚’å®Ÿè¡Œï¼š
 
      ```bash
      trap 'unset TOKEN ROLE CREDS' EXIT
      export AWS_S3_BUCKET="dolcos-calc-prod-assets"
      export AWS_REGION="ap-northeast-1"
      set -euo pipefail

      # â‘  IMDSv2ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆéè¡¨ç¤ºï¼‰
      TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" \
        -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

      # â‘¡ ãƒ­ãƒ¼ãƒ«åå–å¾—ï¼ˆéè¡¨ç¤ºï¼‰
      ROLE=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
        http://169.254.169.254/latest/meta-data/iam/security-credentials/)

      # â‘¢ è³‡æ ¼æƒ…å ±ã®å­˜åœ¨ã¨æœŸé™ã ã‘ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      CREDS=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
        "http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE")
      echo "$CREDS" | jq -e '.Expiration' >/dev/null

      # â‘£ ãƒ­ãƒ¼ãƒ«ç´ä»˜ã‘ã®å­˜åœ¨ã ã‘ç¢ºèªï¼ˆå‡ºåŠ›ã—ãªã„ï¼‰
      curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
        http://169.254.169.254/latest/meta-data/iam/info >/dev/null

      # â‘¤ èªè¨¼ã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰
      aws sts get-caller-identity >/dev/null

      # â‘¥ S3æ¨©é™ã®ç–é€šï¼ˆ"S3 OK" ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
      aws s3 ls "s3://$AWS_S3_BUCKET" --region "$AWS_REGION" >/dev/null \
        && echo "S3 OK" || echo "S3 NG"
      ```

   * "S3 OK" ã§æ¨©é™ OK ã§ã™ã€‚ ã‚‚ã†AWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚
   * â€œS3 NGâ€ ã®ã¨ãã®ä»£è¡¨çš„ãªåŸå› ï¼š

      * `AWS_REGION` ãŒãƒã‚±ãƒƒãƒˆã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¨ä¸ä¸€è‡´ â†’ `aws s3api get-bucket-location --bucket "$AWS_S3_BUCKET"`
      * EC2 ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«ã« S3 ã®è¨±å¯ä¸è¶³ â†’ `s3:ListBucket` / `s3:GetObject` ãªã©ã‚’ãƒãƒªã‚·ãƒ¼ã§ä»˜ä¸
      * ãƒã‚±ãƒƒãƒˆåã®ã‚¹ãƒšãƒ«é•ã„ / å­˜åœ¨ã—ãªã„ãƒã‚±ãƒƒãƒˆ

## 12. **Active Storageã‚’S3ã«å‘ã‘ã‚‹**

### 1. `docker-compose.prod.yml` ã«`environment`ã‚’è¿½è¨˜

* `docker-compose.prod.yml` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹

   ```yaml
   services:
     db:
       image: postgres:16
       environment:
         POSTGRES_USER: ${POSTGRES_USER}
         POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
         POSTGRES_DB: ${POSTGRES_DB}
       volumes:
         - db-data:/var/lib/postgresql/data
       healthcheck:
         test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
         interval: 5s
         timeout: 5s
         retries: 20
       restart: unless-stopped

     app:
       build:
         context: .
         dockerfile: app/Dockerfile.prod
         secrets:
           - rails_master_key
       env_file: .env                      # â† EC2 ã«ä½œã£ãŸ .env ã‚’åˆ©ç”¨
       depends_on:
         db:
           condition: service_healthy
       ports:
         - "127.0.0.1:3000:3000"
       environment:
         RAILS_ENV: "production"
         RACK_ENV:  "production"
         RAILS_SERVE_STATIC_FILES: "1"
         RAILS_LOG_TO_STDOUT: "1"
         AWS_REGION: "ap-southeast-2"              # åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å
         AWS_S3_BUCKET: "dolcos-calc-prod-assets"  # S3ã®ãƒã‚±ãƒƒãƒˆå
       secrets:
         - rails_master_key
       command: bash -lc "bundle exec rails db:migrate && bundle exec rails server -b 0.0.0.0 -p 3000"
       restart: unless-stopped
        volumes:
          - ./config/credentials/production.key:/app/config/credentials/production.key:ro

   secrets:
     rails_master_key:
       file: ./config/credentials/production.key

   volumes:
     db-data:
   ```
### 2. Railsã®è¨­å®š
* `config\storage.yml` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹

   ```yaml
   test:
     service: Disk
     root: <%= Rails.root.join("tmp/storage") %>

   local:
     service: Disk
     root: <%= Rails.root.join("storage") %>

   amazon:
     service: S3
     region: <%= ENV["AWS_REGION"] %>
     bucket: <%= ENV["AWS_S3_BUCKET"] %>
   ```
* `config\environments\production.rb` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹

   ```ruby
   require "active_support/core_ext/integer/time"
   Rails.application.configure do
     #...(çœç•¥)...
     config.active_storage.service = :amazon
     #...(çœç•¥)...
   end
   ```
### 3. Gem ã‚’è¿½åŠ 
* `Gemfile`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹

   ```ruby
   gem "aws-sdk-s3", "~> 1.139"
   gem "image_processing", "~> 1.12"  # ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ã‚„ç”»åƒå¤‰æ›ã‚’ä½¿ã†ãªã‚‰æ¨å¥¨ï¼‰
   ```
* ãƒ­ãƒ¼ã‚«ãƒ«ã§`Gemfile.lock`ã‚’æ›´æ–°ã™ã‚‹

   ```bash
   docker compose run --rm app bundle install
   docker compose restart app
   ```
* â€»ã‚³ãƒŸãƒƒãƒˆæ™‚ã«`Gemfile.lock`ã‚‚å«ã‚ã‚‹ã“ã¨ï¼

### 4.EC2ã§ç¢ºèª
* èµ·å‹•ãƒ»ç¢ºèª

   ```bash
   # è¿½åŠ ã—ãŸGemã‚’åæ˜ ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸å†ãƒ“ãƒ«ãƒ‰
   docker compose -f docker-compose.prod.yml build --no-cache app
   # ã‚³ãƒ³ãƒ†ãƒŠå†èµ·å‹•
   docker compose -f docker-compose.prod.yml up -d

   # èµ·å‹•ç¢ºèªï¼ˆãƒ­ã‚°ã‚’è¦—ãï¼‰
   docker compose -f docker-compose.prod.yml logs --tail=200 app
   # Active Storage ãŒ :amazon ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
   docker compose -f docker-compose.prod.yml exec app rails r 'p Rails.application.config.active_storage.service'
   # => :amazon ãŒå‡ºã‚Œã°OK
   ```
## 13. **RDSã¨ã®é€£æº**

* ğŸ§­ ã‚¹ãƒ†ãƒƒãƒ— 1ï¼šRDS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã

   1. ãƒ–ãƒ©ã‚¦ã‚¶ã§
      ğŸ‘‰ [https://console.aws.amazon.com/rds/](https://console.aws.amazon.com/rds/)
      ã«ã‚¢ã‚¯ã‚»ã‚¹
   2. å³ä¸Šã§ **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒã€Œã‚¢ã‚¸ã‚¢ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ï¼ˆæ±äº¬ï¼‰ap-northeast-1ã€** ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
      ï¼ˆEC2 ã¨åŒã˜ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰

---

* ğŸ§± ã‚¹ãƒ†ãƒƒãƒ— 2ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ

   1. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œ**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**ã€ã‚’é¸æŠ
   2. å³ä¸Šã€Œ**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ**ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

---

* ğŸ§© ã‚¹ãƒ†ãƒƒãƒ— 3ï¼šåŸºæœ¬è¨­å®š

   | è¨­å®šé …ç›®             | æ¨å¥¨å€¤ãƒ»èª¬æ˜                                      |
   | ---------------- | ------------------------------------------- |
   | **ä½œæˆæ–¹æ³•**         | æ¨™æº–ä½œæˆ                                        |
   | **ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¿ã‚¤ãƒ—**  | PostgreSQL |
   | **ã‚¨ãƒ³ã‚¸ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³**   | PostgreSQL 17.6-R2ï¼ˆæœ€æ–°ã®ãƒã‚¤ãƒŠãƒ¼ï¼ˆRDSã® R ç•ªå·ä»˜ãï¼‰ï¼‰                 |
   | **RDS å»¶é•·ã‚µãƒãƒ¼ãƒˆ**   | ç„¡åŠ¹ |
   | **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**       | é–‹ç™º/ãƒ†ã‚¹ãƒˆï¼ˆå°è¦æ¨¡ãªã‚‰ï¼‰ã¾ãŸã¯æœ¬ç•ª                          |
   | **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³** | ã‚·ãƒ³ã‚°ãƒ« AZ DB ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ (1 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹) |
   | **DB ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è­˜åˆ¥å­** | dolcos-dbï¼ˆä»»æ„ï¼‰                               |
   | **ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼å** | `postgres` |
   | **èªè¨¼æƒ…å ±ç®¡ç†** | ã‚»ãƒ«ãƒ•ãƒãƒãƒ¼ã‚¸ãƒ‰ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ |

   â€» èªè¨¼æƒ…å ±ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸå¾Œã«ç¢ºèªã§ãã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆãƒãƒŠãƒ¼ã® [èªè¨¼æƒ…å ±ã®è©³ç´°ã‚’è¡¨ç¤º] ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

---

* ğŸ’¾ ã‚¹ãƒ†ãƒƒãƒ— 4ï¼šã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®š ~

   | è¨­å®š               | æ¨å¥¨å€¤ï¼ˆå°è¦æ¨¡æƒ³å®šï¼‰                             |
   | ---------------- | -------------------------------------- |
   | **DB ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒ©ã‚¹** | `db.t4g.micro` or `db.t3.micro`ï¼ˆç„¡æ–™æ å¯¾å¿œï¼‰ |
   | **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—**     | æ±ç”¨ SSD (gp2)                           |
   | **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚º**     | 20GBï¼ˆå¾Œã§æ‹¡å¼µå¯ï¼‰                       |
   | **è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**     | ç„¡åŠ¹ï¼ˆåˆæœŸæ®µéšã§ã¯å›ºå®šï¼‰                           |
   | **ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚½ãƒ¼ã‚¹**          | EC2 ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚½ãƒ¼ã‚¹ã«æ¥ç¶š                    |
   | **EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**    | `dolcos-calc-server` ã‚’é¸æŠ<br>ã“ã“ã‚’é¸ã¶ã¨ã€RDS å´ãŒâ€œEC2ã‹ã‚‰DBã¸å…¥ã‚Œã‚‹ã‚ˆã†ã«â€SGã‚’è‡ªå‹•èª¿æ•´ã—ã¾ã™ã€‚               |
   | **DB ã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—** | è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—                          |
   | **VPC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**            | ã¾ãšã¯ ã€Œæ—¢å­˜ã®é¸æŠã€ ã§OK<br>å°†æ¥çš„ã«ã¯ RDSå°‚ç”¨SGï¼ˆä¾‹ï¼š`dolcos-db-sg`ï¼‰ ã‚’ä½œã‚Šã€ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ 5432/TCP ã®â€œã‚½ãƒ¼ã‚¹â€ã« EC2å´SGï¼ˆä¾‹ï¼š`dolcos-calc-sg`ï¼‰ ã‚’æŒ‡å®šã™ã‚‹æ§‹æˆãŒãƒ™ã‚¹ãƒˆ                                  |
   | **è¿½åŠ ã® VPC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**   | é¸æŠãªã— |
   | **èªè¨¼æ©Ÿé–¢**   | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
   | **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒˆ**   | 5432 |
   | **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èªè¨¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³**   | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼       |
   | **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ**   | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆ - ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰  |
   | **Performance Insights** | æœ‰åŠ¹ |
   | **ä¿æŒæœŸé–“** | 7æ—¥ |
   | **AWS KMS ã‚­ãƒ¼** | default |
   | **æ‹¡å¼µãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**   | æœ‰åŠ¹       |
   | **OS ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è©³ç´°åº¦** | 60ç§’ |
   | **OS ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®å½¹å‰²** | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
   | **ãƒ­ã‚°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ** | PostgreSQL ãƒ­ã‚°ã®ã¿âœ… |
   | **DevOps Guru** | OFFï¼ˆã‚ã¨ã‹ã‚‰ONå¯ï¼‰ |

---

* ğŸ•’ ã‚¹ãƒ†ãƒƒãƒ— 5ï¼šè¿½åŠ è¨­å®š

   å±•é–‹ã—ã¦æ¬¡ã®é …ç›®ã‚’è¨­å®šï¼š

   | é …ç›®              | è¨­å®šå€¤                       |
   | --------------- | ------------------------- |
   | **æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å**   | `dolcos_production`       |
   | **DB ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚°ãƒ«ãƒ¼ãƒ—**   | æ—¢å®šã§OKï¼ˆå¾Œã‹ã‚‰å¤‰æ›´å¯ï¼‰             |
   | **è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**   | æœ‰åŠ¹             |
   | **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿æŒæœŸé–“**  | 7æ—¥ï¼ˆæ¨å¥¨ï¼‰                    |
   | **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦**  | ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é¸æŠ â‡’ 18:00 UTC 0.5æ™‚é–“                    |
   | **ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼**          | âœ…ãƒã‚§ãƒƒã‚¯ |
   | **åˆ¥ã® AWS ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–**          | ã‚ªãƒ• |
   | **æš—å·ã‚’æœ‰åŠ¹åŒ–**          | âœ…ãƒã‚§ãƒƒã‚¯ |
   | **ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³è‡ªå‹•ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰**   | æœ‰åŠ¹             |
   | **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦** | ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é¸æŠ â‡’ åœŸæ›œæ—¥ 19:00 UTC 0.5æ™‚é–“     |

---
* ğŸš€ ã‚¹ãƒ†ãƒƒãƒ— 6ï¼šä½œæˆã‚’ã‚¯ãƒªãƒƒã‚¯

   æ•°åˆ†ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚  
   ä½œæˆå®Œäº†å¾Œã€ä¸€è¦§ã«æ–°ã—ã„ DB ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

---

* ğŸ”‘ ã‚¹ãƒ†ãƒƒãƒ— 7ï¼šæ¥ç¶šæƒ…å ±ã‚’ç¢ºèª

   1. ä½œæˆã—ãŸ DB ã‚’ã‚¯ãƒªãƒƒã‚¯
   2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆãƒãƒŠãƒ¼ã® [`æ¥ç¶šã®è©³ç´°ã‚’è¡¨ç¤º`] ã‚’ã‚¯ãƒªãƒƒã‚¯ â‡’ æƒ…å ±ã‚’æ§ãˆã‚‹  
      * **â€» ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã§ãã‚‹ã®ã¯ã“ã®ã¨ãã ã‘ã§ã™ã€‚**  
         å‚ç…§ç”¨ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚  
         ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç´›å¤±ã—ãŸå ´åˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
   2. **ã€Œæ¥ç¶šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã‚¿ãƒ–**ã‚’é–‹ã
   3. **ã€Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€**ã¨**ã€Œãƒãƒ¼ãƒˆã€**ã‚’æ§ãˆã¦ãŠãã¾ã™

      * ä¾‹ï¼š`dolcos-db.xxxxxxxxx.ap-northeast-1.rds.amazonaws.com:5432`

   ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã€Rails ã® `.env.prod` ã«æ›¸ã `DATABASE_URL` ã®ãƒ›ã‚¹ãƒˆéƒ¨åˆ†ã§ã™ã€‚

---

* âœ… ã‚¹ãƒ†ãƒƒãƒ— 8ï¼šå‹•ä½œç¢ºèªï¼ˆEC2ã‹ã‚‰ï¼‰

   ```bash
   # EC2 å†…ã§ï¼ˆã¾ãŸã¯ Docker å†…ã§ï¼‰
   cd ~/dolcos-calc
   docker compose -f docker-compose.prod.yml exec app rails r "puts ActiveRecord::Base.connection.execute('select current_timestamp').to_a"
   # {"current_timestamp"=>2025-10-20 06:24:31.325099 +0000}ãŒè¿”ã‚Œã°ç–é€šOK
   ```

æ¥ç¶šã§ãã‚Œã°æˆåŠŸã€‚
ã“ã‚Œã§æ¬¡ã®æ‰‹é †ã€Œã‚¢ãƒ—ãƒªç”¨ DB ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆdolcos_appï¼‰ã€ã«é€²ã‚ã¾ã™ã€‚

## 14. ã‚¢ãƒ—ãƒªç”¨ DB ã‚’ RDS ã¸å‘ã‘ã‚‹
* **ã‚¹ãƒ†ãƒƒãƒ— 1. ã‚¢ãƒ—ãƒªç”¨ DB ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœ€å°æ¨©é™ï¼‰**

   ä¸€æ™‚ psql ã‚³ãƒ³ãƒ†ãƒŠã§å…¥ã‚‹ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯RDSä½œæˆæ™‚ã®postgresï¼‰
   ```bash
   docker run --rm -it postgres:17-alpine psql -h <RDSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ> -U postgres -d dolcos_production
   ```
   `dolcos_production=>` ã¨ãªã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›

   ```sql
   -- 1) ã‚¢ãƒ—ãƒªç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼
   CREATE USER dolcos_app WITH PASSWORD 'å¼·ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰';
   -- 2) DBæ¥ç¶šæ¨©é™
   GRANT CONNECT ON DATABASE dolcos_production TO dolcos_app;
   -- 3) publicã‚¹ã‚­ãƒ¼ãƒã§ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã§ãã‚‹ã‚ˆã†ã«
   GRANT USAGE, CREATE ON SCHEMA public TO dolcos_app;
   -- 4) æ—¢å­˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®æ¨©é™ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ« & ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼‰
   GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO dolcos_app;
   GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO dolcos_app;
   -- 5) ã“ã‚Œã‹ã‚‰ä½œã‚‰ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™
   --   ï¼ˆã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸâ€œãƒ­ãƒ¼ãƒ«ãŒå°†æ¥ä½œã‚‹â€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨ï¼‰
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO dolcos_app;
   ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO dolcos_app;
   -- TimeZoneã‚’å¤‰æ›´ã™ã‚‹ãªã‚‰
   ALTER DATABASE dolcos_production SET timezone = 'Asia/Tokyo';
   -- ãã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å³æ™‚åæ˜ ã•ã›ã‚‹ãªã‚‰
   SET timezone = 'Asia/Tokyo';
   -- ç¢ºèª
   SHOW timezone;                -- â†’ Asia/Tokyo
   SELECT current_timestamp;     -- â†’ +09:00 ã§å‡ºã‚‹
   \q
   ```
   `.env`ï¼ˆEC2 å´ / æ—¢å­˜ã«è¿½è¨˜ï¼‰
   ```bash
   cd ~/dolcos-calc

   # 1) ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   cp .env .env.bak-$(date +%F_%H%M%S)

   # 2) æœ¬ç•ªå¿…é ˆã®å€¤ã‚’å…¥ã‚Œã‚‹ï¼ˆ<>ã¯é©å®œï¼‰
   export RDS_HOST="<RDSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ>"
   export APP_DB_USER="dolcos_app"
   export APP_DB_PASS_RAW="<ã‚¢ãƒ—ãƒªDBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰>"

   # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆè¨˜å·ãŒã‚ã‚‹ã¨ãå¿…é ˆï¼‰
   export APP_DB_PASS_ENC=$(python3 -c "import os,urllib.parse; print(urllib.parse.quote(os.environ['APP_DB_PASS_RAW']))")
   
   # 3) ç½®æ›ï¼†è¿½è¨˜
   # RAILS_ENV
   grep -q '^RAILS_ENV=' .env && sed -i 's/^RAILS_ENV=.*/RAILS_ENV=production/' .env || echo 'RAILS_ENV=production' >> .env

   # DATABASE_URL
   if grep -q '^DATABASE_URL=' .env; then
     sed -i -E 's|^DATABASE_URL=.*$|DATABASE_URL=postgres://'"$APP_DB_USER"':'"$APP_DB_PASS_ENC"'@'"$RDS_HOST"':5432/dolcos_production|' .env
   else
     echo "DATABASE_URL=postgres://$APP_DB_USER:$APP_DB_PASS_ENC@$RDS_HOST:5432/dolcos_production" >> .env
   fi

   # 4) ãƒ­ãƒ¼ã‚«ãƒ«ç”¨POSTGRES_*ã‚’å‰Šé™¤
   sed -i -E '/^POSTGRES_(USER|PASSWORD|DB)=/d' .env

   # 5) ãƒã‚¹ã‚¯ã—ã¦ç¢ºèª
   echo "--- masked preview ---"
   sed -E \
     -e 's#(DATABASE_URL=postgres://[^:]+:)[^@]+#\1********#' \
     -e 's#(SECRET_KEY_BASE=).*#\1********#' \
     -e 's#(SMTP_PASSWORD=).*#\1********#' \
     .env | grep -E '^(RAILS_ENV|DATABASE_URL|SECRET_KEY_BASE|APP_HOST|MAILER_SENDER|SMTP_)='
   ```

   å†èµ·å‹•ã—ã¦ç¢ºèª
   ```bash
   docker compose -f docker-compose.prod.yml up -d --force-recreate app
   docker compose -f docker-compose.prod.yml exec app rails r "puts ActiveRecord::Base.connection.execute('select current_user').to_a"
   ```
   `{"current_user"=>"dolcos_app"}` ãŒå‡ºã‚Œã°OK

* **ã‚¹ãƒ†ãƒƒãƒ— 2. RDS é€£æºå‰ã®æš«å®šç–é€šç”¨ã¨ã—ã¦ db ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«Postgresï¼‰ã‚’å…¥ã‚Œã¦ã„ãŸåæ®‹ã‚’å‰Šé™¤**

   `docker-compose.prod.yml` ã‚’ä»¥ä¸‹ã«ä¿®æ­£

    ```yaml
    services:
      app:
        build:
          context: .
          dockerfile: app/Dockerfile.prod
          secrets:
            - rails_master_key
            - db_url
        env_file: .env                      # â† EC2 ã«ä½œã£ãŸ .env ã‚’åˆ©ç”¨
        ports:
          - "127.0.0.1:3000:3000"
        environment:
          RAILS_ENV: "production"
          RACK_ENV:  "production"
          RAILS_SERVE_STATIC_FILES: "1"
          RAILS_LOG_TO_STDOUT: "1"
          AWS_REGION: "ap-southeast-2"
          AWS_S3_BUCKET: "dolcos-calc-prod-assets"
        secrets:
          - rails_master_key
        command: bash -lc "bundle exec rails db:migrate && bundle exec rails server -b 0.0.0.0 -p 3000"
        restart: unless-stopped
        volumes:
          - ./config/credentials/production.key:/app/config/credentials/production.key:ro

    secrets:
      rails_master_key:
        file: ./config/credentials/production.key
      db_url:
        environment: DATABASE_URL
    ```
   `Dockerfile.prod` ã‚’ä¿®æ­£
   ```dockerfile
   # syntax=docker/dockerfile:1.7
   FROM public.ecr.aws/docker/library/ruby:3.3-slim
   # ...(çœç•¥)...
      # ãƒ“ãƒ«ãƒ‰æ™‚ã¯ãƒ€ãƒŸãƒ¼ã® SECRET_KEY_BASE ã‚’æ¸¡ã™ï¼ˆå®Ÿè¡Œæ™‚ã¯ .env ã®æœ¬ç‰©ã‚’ä½¿ç”¨ï¼‰
      RUN --mount=type=secret,id=rails_master_key \
         --mount=type=secret,id=db_url \
         sh -lc 'set -eu; \
           RAILS_MASTER_KEY="$(tr -d "\r\n" </run/secrets/rails_master_key)"; \
            DATABASE_URL="$(tr -d "\r\n" </run/secrets/db_url)"; \
            export RAILS_MASTER_KEY DATABASE_URL; \
            export SECRET_KEY_BASE=dummy; \
           bundle exec rails assets:precompile'
   # ...(çœç•¥)...
   ```

   ãƒ­ãƒ¼ã‚«ãƒ«DBã‚³ãƒ³ãƒ†ãƒŠã‚„ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæ®‹ã£ã¦ã„ã‚Œã°æƒé™¤ (EC2å†…)

   ```bash
   # 1) ãƒ­ãƒ¼ã‚«ãƒ«DBã‚³ãƒ³ãƒ†ãƒŠã®ç¢ºèª
   docker ps -a
   # 1) ãƒ­ãƒ¼ã‚«ãƒ«DBã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
   docker rm -f <dbã‚³ãƒ³ãƒ†ãƒŠå>  # ã„ã‚Œã°
   # 2) ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ç¢ºèªï¼ˆdbã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ãƒœãƒªãƒ¥ãƒ¼ãƒ åã‚’ç‰¹å®šï¼‰
   docker volume ls
   # 3) ä¸è¦ãªã‚‰ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤ï¼ˆâ€»æ®‹ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨å‰Šé™¤ï¼‰
   docker volume rm <db-data>   # ã„ã‚Œã°
   # 5) å­¤å…ã‚³ãƒ³ãƒ†ãƒŠ/ã‚µãƒ¼ãƒ“ã‚¹æ•´ç†ï¼ˆdb ã‚’æ¶ˆã—ãŸå¾Œã®æƒé™¤ï¼‰
   docker compose -f docker-compose.prod.yml up -d --remove-orphans
   ```

* **ã‚¹ãƒ†ãƒƒãƒ— 3.åæ˜  & æ¤œè¨¼**

   ```powershell
   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
   docker compose -f docker-compose.prod.yml exec app rails db:migrate

   # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
   docker compose -f docker-compose.prod.yml exec app rails r "puts ActiveRecord::Base.connection.current_database"
   # dolcos_productionãŒå‡ºã‚Œã°æˆåŠŸ
   ```
## 15. Amazon SES (SMTP)ã®åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
* **ğŸ”§ ã‚´ãƒ¼ãƒ«**
    * Amazon SESã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’èªè¨¼
    * SMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™ºè¡Œ
    * Rails ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹
---
* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 1. SES ç®¡ç†ç”»é¢ã‚’é–‹ã**

    1. [AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«](https://console.aws.amazon.com/) ã«ãƒ­ã‚°ã‚¤ãƒ³
    2. ä¸Šéƒ¨ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¿…ãš **ã€Œåˆ©ç”¨ã—ã¦ã„ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹ï¼šã‚¢ã‚¸ã‚¢ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ æ±äº¬ ap-northeast-1ï¼‰ã€** ã«å¤‰æ›´
    3. æ¤œç´¢ãƒãƒ¼ã§ã€Œ**SES**ã€ã¨å…¥åŠ›ã—ã€
    **ã€ŒSimple Email Serviceã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 2. Amazon Simple Email Service (SES) ã® ID ã‚’ä½œæˆ**
    1. ç”»é¢å·¦ä¸Šã® â˜°ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‡ºã—ã¾ã™ã€‚
      * ã€Œè¨­å®šã€ï¼ã€ŒIDã€ã‚’ã‚¯ãƒªãƒƒã‚¯
      * ã€ŒIDã®ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    2. ID ã®ä½œæˆ
        * ID ã‚¿ã‚¤ãƒ—ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³
        * ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼šdolcos-calc.comï¼ˆRoute53 ã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
        * ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚»ãƒƒãƒˆã®å‰²ã‚Šå½“ã¦ï¼šãƒã‚§ãƒƒã‚¯ç„¡ã—
        * ãƒ†ãƒŠãƒ³ãƒˆã«å‰²ã‚Šå½“ã¦ã‚‹ï¼šãƒã‚§ãƒƒã‚¯ç„¡ã—
        * ã‚«ã‚¹ã‚¿ãƒ  MAIL FROM ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ä½¿ç”¨ï¼šãƒã‚§ãƒƒã‚¯ç„¡ã—
        * ID ã‚¿ã‚¤ãƒ—ï¼šEasy DKIM
        * DKIM ç½²åã‚­ãƒ¼ã®é•·ã•ï¼šRSA_2048_BIT
        * DNS ãƒ¬ã‚³ãƒ¼ãƒ‰ã® Route53 ã¸ã®ç™ºè¡Œï¼šæœ‰åŠ¹
        * DKIM ç½²åï¼šæœ‰åŠ¹
        * ã€ŒID ã®ä½œæˆã€ã‚¯ãƒªãƒƒã‚¯
    3. SESãŒè‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã“ã¨
        * `dolcos-calc.com` ç”¨ã® DKIM ç”¨ CNAME ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆ3ä»¶ï¼‰ã‚’è‡ªå‹•ç”Ÿæˆ
        * ãã‚Œã‚‰ã‚’ Route 53 ã®ãƒ›ã‚¹ãƒˆã‚¾ãƒ¼ãƒ³ã«è‡ªå‹•ç™»éŒ²
        * SES ãŒå®šæœŸçš„ã« DNS ã‚’ãƒã‚§ãƒƒã‚¯
        * CNAME ãŒæ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç¢ºèª  

    ã€Œè¨­å®šã€ï¼ã€ŒIDã€ï¼dolcos-calc.comï¼æ¦‚è¦ ã§ã€ID ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒâœ…æ¤œè¨¼æ¸ˆã¿ã«å¤‰ã‚ã£ãŸã‚‰å®Œäº†ã§ã™ã€‚

---

* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 3. SMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ**

    SESã§ã¯é€šå¸¸ã®AWSãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã¯ãªãã€
    **ã€ŒSMTPèªè¨¼å°‚ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€** ã‚’ä½œã‚Šã¾ã™ã€‚

    1. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€ŒSMTP è¨­å®šã€ ã‚’ã‚¯ãƒªãƒƒã‚¯
        * ï¼ˆå·¦ãƒŠãƒ“å†…ã«ã‚ã‚Šã¾ã™ï¼‰
    2. ã€ŒSMTP èªè¨¼æƒ…å ±ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°ã‚’æŒ‡å®š
        * ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆä¾‹ï¼‰ï¼š

          ```
          ses-smtp-user-dolcos
          ```
        * ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

    3. å®Œäº†ç”»é¢ã§ä¸‹è¨˜ã‚’ã‚³ãƒ”ãƒ¼

        * SES ãŒè¡¨ç¤ºã™ã‚‹ä»¥ä¸‹ã®æƒ…å ±ã‚’æ§ãˆã¦ãŠãã¾ã™ï¼š
          | é …ç›®            | ä¾‹                                         |
          | ------------- | ----------------------------------------- |
          | IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼å | ses-smtp-user-dolcos |
          | SMTP ãƒ¦ãƒ¼ã‚¶ãƒ¼å | AKIAXXXXXXXXXXXXX                         |
          | SMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ | `xxxxxx`ï¼ˆç”Ÿæˆã•ã‚ŒãŸé•·ã„æ–‡å­—åˆ—ï¼‰                      |
          > **âš ï¸ ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯äºŒåº¦ã¨è¦‹ã‚Œãªã„ã®ã§ã€**  
          > **`.env`ã‚„ `.env.prod` ãªã©ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚**  
        * ä»¥ä¸‹ã®é …ç›®ã¯ã€ã€ŒSMTP è¨­å®šã€ç”»é¢ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
          | é …ç›®            | ä¾‹                                         | èª¬æ˜ |
          | ------------- | ----------------------------------------- |------ |
          | **SMTP ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ** | `email-smtp.ap-northeast-1.amazonaws.com` |  |
          | **ãƒãƒ¼ãƒˆ**         | `587`                                     | STARTTLSã€‚æ¨å¥¨ãƒãƒ¼ãƒˆ                       |
          | **TLS**         | æœ‰åŠ¹ï¼ˆSTARTTLSï¼‰                              | Rails ã® `enable_starttls_auto: true` |

---

* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 4. SES ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹è§£é™¤ï¼ˆä»»æ„ã ã‘ã©å¿…é ˆï¼‰**

    åˆæœŸçŠ¶æ…‹ã®SESã¯ã€Œã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã€å†…ãªã®ã§
    * èªè¨¼æ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã¦**ã«ã—ã‹é€ã‚Œãªã„**
    * 1æ—¥200é€šã®é€ä¿¡åˆ¶é™ï¼ˆã‹ã¤1ç§’1é€šï¼‰

    æœ¬ç•ªã§ä½¿ã†ã«ã¯**ã‚µãƒãƒ¼ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã€Œæœ¬ç•ªã‚¢ã‚¯ã‚»ã‚¹ã€ç”³è«‹**ãŒå¿…è¦ã§ã™ã€‚

    1. AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šéƒ¨ã§ã€Œ**Service Quotas**ã€ã‚’æ¤œç´¢ã—ã¦é–‹ã
        * ç”»é¢ä¸Šéƒ¨ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãŒã€åˆ©ç”¨ä¸­ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚ï¼ˆä¾‹ï¼šã‚¢ã‚¸ã‚¢ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ æ±äº¬ï¼‰
    2. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ **AWS ã®ã‚µãƒ¼ãƒ“ã‚¹** ã‚’ã‚¯ãƒªãƒƒã‚¯
    3. ä¸€è¦§ã‹ã‚‰ **Amazon Simple Email Service (Amazon SES)** ã‚’é¸æŠ
    4. ã€Œ**Sending quota**ã€ã‚’é¸æŠã—ã¦ã€ç”»é¢å³ä¸Šã® **ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®å¼•ãä¸Šã’ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    5. ã‚¯ã‚©ãƒ¼ã‚¿å€¤ã‚’å¼•ãä¸Šã’ã‚‹ï¼š50000
        *  â†’ ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã€

    â†’ é€ä¿¡å¾Œã€æ•°æ™‚é–“ã€œ1æ—¥ç¨‹åº¦ã§è§£é™¤ã•ã‚Œã¾ã™ã€‚  
    ãƒ¡ãƒ¼ãƒ«ã§ã€Œapprovedã€ã¨è¿”ã£ã¦ããŸã‚‰OKã€‚

---
* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 5. credentials ã« SES è¨­å®šã‚’è¿½è¨˜ã™ã‚‹**
    1. ãƒ­ãƒ¼ã‚«ãƒ«ã® Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ credentials ã‚’ç·¨é›†ã™ã‚‹

        ```powershell
        cd C:\dev\dolcos_calc
        $KEY = Get-Content -Raw .\config\credentials\production.key
        docker compose run --rm -e RAILS_ENV=production -e RACK_ENV=production -e RAILS_MASTER_KEY="$KEY" app sh -lc "apt-get update >/dev/null 2>&1 && apt-get install -y nano >/dev/null 2>&1 || true; EDITOR=nano bundle exec rails credentials:edit --environment production"
        ```

        `nano`ãŒèµ·å‹•ã™ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

        ```yaml
        # smtp:
        #   user_name: my-smtp-user
        #   password: my-smtp-password
        #
        # aws:
        #   access_key_id: 123
        #   secret_access_key: 345

        # Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
        smtp:
          address: "<SMTP ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ä¾‹ï¼šemail-smtp.ap-southeast-2.amazonaws.com>"
          port: 587
          user_name: "<ã‚ãªãŸã®SMTPãƒ¦ãƒ¼ã‚¶ãƒ¼å>"
          password: "<ã‚ãªãŸã®SMTPãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰>"
          authentication: "login"
          enable_starttls_auto: true

        aws:
          region: "<åˆ©ç”¨ã—ã¦ã„ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ ä¾‹ï¼šap-southeast-2>"

        secret_key_base: xxxx......
        ```

        ç·¨é›†ãŒçµ‚ã‚ã£ãŸã‚‰ã€
        * `Ctrl + O`ã§ä¿å­˜
        * `Ctrl + X`ã§çµ‚äº†

    2. âœ… ä¿å­˜ã§ããŸã‹ç¢ºèª

        ```powershell
        # .enc ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ï¼‰
        Get-ChildItem .\config\credentials\production.yml.enc

        # nanoã‚’ã‚‚ã†ä¸€åº¦å®Ÿè¡Œã—ã€å¹³æ–‡ã®YAMLãŒèª­ã‚ã‚‹ï¼ˆä¾‹ï¼šsmtp: ã®å€¤ãŒè¦‹ãˆã‚‹ï¼‰ãªã‚‰ å¾©å·OK ã§ã™ã€‚
        # ä½•ã‚‚ç·¨é›†ã›ãš Ctrl+X ã§é–‰ã˜ã‚Œã°ã€ç„¡é§„ãªå†æš—å·åŒ–ã¯ç™ºç”Ÿã—ã¾ã›ã‚“ã€‚
        $KEY = Get-Content -Raw .\config\credentials\production.key
        docker compose run --rm -e RAILS_ENV=production -e RACK_ENV=production -e RAILS_MASTER_KEY="$KEY" app sh -lc "apt-get update >/dev/null 2>&1 && apt-get install -y nano >/dev/null 2>&1 || true; EDITOR=nano bundle exec rails credentials:edit --environment production"
        ```

    3. ç·¨é›†ã—ãŸ `production.yml.enc` ã‚’ Git ã« push ã—ã¦ã€EC2 å´ã§ pullã™ã‚‹

    4. EC2å´ã§ production.yml.enc ã‚’åæ˜ 

        credentialsãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã§å†ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ã§ã™ã€‚
---
* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 6. Railsè¨­å®šã‚’SESå¯¾å¿œã«ã™ã‚‹**

    `config/environments/production.rb` ã®ä¸­ã‚’æ¬¡ã®ã‚ˆã†ã«ç·¨é›†ãƒ»è¿½è¨˜ã—ã¾ã™

    ```ruby
    # config/environments/production.rb

    Rails.application.configure do
      # ...ï¼ˆä¸­ç•¥ï¼‰...

      # SES (SMTP) è¨­å®š
      config.action_mailer.smtp_settings = Rails.application.credentials.smtp

      config.action_mailer.default_url_options = {
        host: "dolcos-calc.com",
        protocol: "https"
      }

      config.action_mailer.default_options = {
        from: "noreply@dolcos-calc.com"
      }

      # å®Ÿéš›ã«é€ã‚‹
      config.action_mailer.delivery_method = :smtp
      config.action_mailer.perform_deliveries = true
      config.action_mailer.raise_delivery_errors = true
    end
    ```

    **â€» ã‚¹ãƒ†ãƒƒãƒ— 5 ã‚¹ãƒ†ãƒƒãƒ— 6 ã®ç·¨é›†å†…å®¹ã‚’ Git ã«ã‚³ãƒŸãƒƒãƒˆ â†’ EC2 å´ã«åæ˜ ã€ã‚’å¿˜ã‚Œãšã«ï¼**
---
* **ğŸªœ ã‚¹ãƒ†ãƒƒãƒ— 7. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆ**

    1. ãƒ“ãƒ«ãƒ‰ â†’ å†èµ·å‹• (EC2 å´)

        credentialsãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã§å†ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ã§ã™ã€‚
        ``` bash
        DOCKER_BUILDKIT=1 docker compose -f docker-compose.prod.yml build --no-cache app
        docker compose -f docker-compose.prod.yml up -d
        ```
    2. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’EC2ä¸Šã§å®Ÿè¡Œã—ã¦ã€å®Ÿéš›ã«SESçµŒç”±ã§é€ä¿¡ã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

        ```bash
        docker compose -f docker-compose.prod.yml exec app bash -lc '
        RAILS_ENV=production \
        bundle exec rails r "ActionMailer::Base.mail(from: \"noreply@dolcos-calc.com\", to: \"ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹\", subject: \"SES test from EC2\", body: \"âœ… Amazon SES SMTP test mail from dolcos-calc.com\" ).deliver_now"'
        ```
        **ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹è§£é™¤å‰ãªã‚‰ã€**  
        ã€Œã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ ã«ã¯ **SES ã§æ¤œè¨¼æ¸ˆã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹**ã‚’ä½¿ã£ã¦ãã ã•ã„  
        ï¼ˆâ€» æœªæ¤œè¨¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ï¼‰

---



<br><br><br><br><br><br><br><br><br><br>
# AWSã®æœ¬ç•ªç’°å¢ƒã®å®‰å…¨æ€§

## **ã€ŒIAMã€ ã€Œãƒ­ãƒ¼ãƒ«ã€ ã€Œã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«ã€ ã€ŒS3é€£æºã€ã®é–¢ä¿‚**

### ğŸ§­ ã¾ãšåŸºæœ¬ç”¨èªã®æ•´ç†

| ç”¨èª                                      | æ„å‘³                                                                           |
| --------------------------------------- | ---------------------------------------------------------------------------- |
| **IAMï¼ˆIdentity and Access Managementï¼‰** | AWSã®ã€Œæ¨©é™ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã€ã€‚èª°ãŒã©ã®AWSãƒªã‚½ãƒ¼ã‚¹ï¼ˆS3ã‚„EC2ãªã©ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ã‚’åˆ¶å¾¡ã™ã‚‹ä»•çµ„ã¿ã€‚                       |
| **IAMãƒ¦ãƒ¼ã‚¶ãƒ¼**                             | ç‰¹å®šã®äººï¼ˆã‚ãªãŸè‡ªèº«ã‚„é–‹ç™ºè€…ï¼‰ã‚’è¡¨ã™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€‚AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ç™ºè¡Œã§ãã‚‹ã€‚                       |
| **IAMãƒ­ãƒ¼ãƒ«**                              | ã€Œã“ã®æ¨©é™ã§AWSã®ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ“ä½œã—ã¦ã„ã„ã§ã™ã‚ˆã€ã¨ã„ã†â€œæ¨©é™ã‚»ãƒƒãƒˆâ€ã€‚                                       |
| **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«**                           | EC2 ã«ä»˜ã‘ã‚‹ **IAMãƒ­ãƒ¼ãƒ«** ã®ã“ã¨ã€‚EC2 ãŒè‡ªåˆ†è‡ªèº«ã¨ã—ã¦ AWS ã® APIï¼ˆS3ãªã©ï¼‰ã‚’å©ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚ã¤ã¾ã‚Šã€ŒEC2æœ¬äººã®æ¨©é™ã€ã€‚ |


### ğŸ§© ãªãœã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ã‹ï¼Ÿ

Railsï¼ˆActive Storageï¼‰ãŒS3ã¸ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ãã€
é€šå¸¸ã¯ **AWSã®API** ã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

* APIã‚’å‘¼ã¶ã«ã¯ã€Œèª°ãŒå‘¼ã‚“ã§ã„ã‚‹ã‹ï¼ˆèªè¨¼æƒ…å ±ï¼‰ã€ãŒå¿…è¦
* EC2ãŒã€Œè‡ªåˆ†è‡ªèº«ã®æ¨©é™ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€ã‚ˆã†ã«ã™ã‚‹ã®ãŒ **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ­ãƒ¼ãƒ«**

âœ… ãƒ¡ãƒªãƒƒãƒˆ

* `.env` ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ä¿å­˜ã™ã‚‹å¿…è¦ãŒãªã„ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰
* ã‚­ãƒ¼ã®æµå‡ºãƒªã‚¹ã‚¯ã‚¼ãƒ­
* æ¨©é™ã‚’ä¸­å¤®ç®¡ç†ã§ãã‚‹

---

## **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**

* `.env` ã«å«ã¾ã‚Œã‚‹ç§˜å¯†å€¤ã¯å¤–éƒ¨ã«å‡ºã•ãªã„ï¼ˆS3 / Parameter Storeãªã©ã§ç®¡ç†äºˆå®šï¼‰
* **SSHãƒãƒ¼ãƒˆ (22)** ã¯ â€œè‡ªåˆ†ã®IPã ã‘â€ è¨±å¯

---

## **SSM Parameter Store / Secrets Manager ç®¡ç†**

* æœ€åˆã¯ `Docker secrets` ã§ã®ç®¡ç† â†’ AWS SSM ã¸ç§»è¡Œã™ã‚‹å ´åˆ  

    > **ç§»è¡Œã‚³ã‚¹ãƒˆã¯ä¸­ã€œä½ç¨‹åº¦**ï¼ˆå¾Œã‹ã‚‰ã§ã‚‚ååˆ†ç§»è¡Œå¯èƒ½ï¼‰  
    > **èª²é‡‘ã¯ã”ãã‚ãšã‹**ã§ã€å€‹äººã€œå°è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ã»ã¼èª¤å·®ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚

---

* **ğŸªœ 1. ç§»è¡Œã‚³ã‚¹ãƒˆã«ã¤ã„ã¦**

    ### âœ… ç¾çŠ¶

    * ç¾åœ¨ã¯ `production.key` ã‚’ãƒ›ã‚¹ãƒˆã«ç½®ã„ã¦ `volumes:` ã§ã‚³ãƒ³ãƒ†ãƒŠã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚
      â†’ Rails è‡ªä½“ã¯ `ENV["RAILS_MASTER_KEY"]` ã«å€¤ãŒã‚ã‚Œã°å‹•ä½œOKã€‚

    ### âœ… SSM Parameter Store / Secrets Manager ã¸ç§»è¡Œã™ã‚‹å ´åˆ

    åŸºæœ¬çš„ã«æ¬¡ã®3ã‚¹ãƒ†ãƒƒãƒ—ã ã‘ã§ã™ï¼š

    1. **AWS å´ã«ç™»éŒ²**

          ```bash
          aws ssm put-parameter \
            --name "/dolcos-calc/rails/production_key" \
            --value "$(cat config/credentials/production.key)" \
            --type SecureString
          ```

          ã¾ãŸã¯ Secrets Manager:

          ```bash
          aws secretsmanager create-secret \
            --name dolcos-calc/rails/production_key \
            --secret-string "$(cat config/credentials/production.key)"
          ```

    2. **EC2 å´ã§å–å¾—ã—ã¦ç’°å¢ƒå¤‰æ•°ã«è¨­å®š**
          èµ·å‹•æ™‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ compose èµ·å‹•å‰ã«ï¼š

          ```bash
          export RAILS_MASTER_KEY="$(aws ssm get-parameter \
              --name "/dolcos-calc/rails/production_key" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text)"
          ```

          ã¾ãŸã¯ secretsmanager ç‰ˆï¼š

          ```bash
          export RAILS_MASTER_KEY="$(aws secretsmanager get-secret-value \
              --secret-id dolcos-calc/rails/production_key \
              --query "SecretString" \
              --output text)"
          ```

    3. **docker-compose.prod.yml ã® `volumes:` ã‚’å‰Šé™¤**

          ```yaml
          environment:
            RAILS_ENV: production
            RAILS_MASTER_KEY: "${RAILS_MASTER_KEY}"
          ```

          ã¨ã—ã¦ã€`docker compose up` å‰ã« export ã—ãŸå¤‰æ•°ã‚’åˆ©ç”¨ã€‚

    ğŸ‘‰ ã¤ã¾ã‚Šã€

    * Rails å´ã®è¨­å®šå¤‰æ›´ã¯ **ä¸è¦**
    * å¤‰æ›´ã™ã‚‹ã®ã¯ **Docker èµ·å‹•å‰ã®ç’°å¢ƒå¤‰æ•°æ³¨å…¥æ–¹æ³•ã®ã¿**
    * **ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—**ã§ç§»è¡Œå®Œäº†

    ### âœ… ã‚³ã‚¹ãƒˆçš„ã«ã¯ã€Œ1æ™‚é–“ã‚ã‚Œã°å®Œå…¨ç§»è¡Œã€ãƒ¬ãƒ™ãƒ«

    Docker secrets â†’ AWS SSM ã‚‚ç›¸æ€§ãŒè‰¯ã„ã®ã§ã€ã‚ã¨ã‹ã‚‰è‡ªç„¶ã«ç§»è¡Œã§ãã¾ã™ã€‚

---

* **ğŸ’° 2. èª²é‡‘ã«ã¤ã„ã¦**

    | ã‚µãƒ¼ãƒ“ã‚¹                        | ç„¡æ–™æ                        | è¶…éæ™‚èª²é‡‘                                         | å‚™è€ƒ                     |
    | --------------------------- | ------------------------- | --------------------------------------------- | ---------------------- |
    | **AWS SSM Parameter Store** | 10,000 ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ã§ç„¡æ–™ï¼ˆæ¨™æº–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰ | ã€ŒSecureStringã€ã‚’ä½¿ã†ã¨ 1ä»¶ã‚ãŸã‚Š **ç´„ $0.05/æœˆ**        | ã»ã¼ç„¡æ–™ã€‚KMSã§æš—å·åŒ–ã•ã‚Œã‚‹ã€‚       |
    | **AWS Secrets Manager**     | ç„¡æ–™æ ãªã—                     | **$0.40/æœˆ/secret + APIå‘¼ã³å‡ºã—èª²é‡‘ï¼ˆ$0.05/10,000å›ï¼‰** | é«˜æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãªã©ï¼‰ |

    > ğŸ’¡ `production.key` ç¨‹åº¦ãªã‚‰ SSM Parameter Store (SecureString) ã§ååˆ†ã€‚  
    > Secrets Manager ã¯èªè¨¼æƒ…å ±ã‚’é »ç¹ã«ãƒ­ãƒ¼ãƒ†ã™ã‚‹ã‚·ãƒŠãƒªã‚ªå‘ã‘ã€‚

---

* **ğŸ§© 3. æ¨å¥¨é‹ç”¨ï¼ˆå°è¦æ¨¡ãªã‚‰ï¼‰**

    | ç”¨é€”                 | ã‚µãƒ¼ãƒ“ã‚¹                                     | ç†ç”±         |
    | ------------------ | ---------------------------------------- | ---------- |
    | Rails ã® master.key | âœ… **SSM Parameter Store (SecureString)** | ç°¡å˜ãƒ»å®‰ã„ãƒ»ååˆ†å®‰å…¨ |
    | DB, SMTP ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰    | âœ… **åŒã˜ã SSM Parameter Store**            | ä¸€å…ƒç®¡ç†å¯èƒ½     |
    | å°†æ¥ã€è¤‡æ•°ã‚µãƒ¼ãƒã§è‡ªå‹•ãƒ­ãƒ¼ãƒ†     | ğŸ” **Secrets Manager ã«æ˜‡æ ¼**               | è‡ªå‹•ãƒ­ãƒ¼ãƒ†æ©Ÿèƒ½ã‚ã‚Š  |

---

* **âœ… ã¾ã¨ã‚**

    | è¦³ç‚¹        | è©•ä¾¡                                |
    | --------- | --------------------------------- |
    | **ç§»è¡Œã‚³ã‚¹ãƒˆ** | â˜…â˜†â˜†ï¼ˆä½ã„ï¼‰Dockerã®ç’°å¢ƒå¤‰æ•°æ³¨å…¥æ–¹æ³•ã‚’å¤‰ãˆã‚‹ã ã‘      |
    | **èª²é‡‘**    | Parameter Storeãªã‚‰ã»ã¼ç„¡æ–™ï¼ˆ$0.05/æœˆ ç¨‹åº¦ï¼‰ |
    | **åˆ©ç‚¹**    | éµã‚’Gitã‚„EC2ã«ç½®ã‹ãšã€AWS IAMã§åˆ¶å¾¡ã§ãã‚‹       |
    | **å°†æ¥æ€§**   | ECS/FargateåŒ–ã€è¤‡æ•°ç’°å¢ƒã¸ã®å±•é–‹ãŒå®¹æ˜“ã«ãªã‚‹       |
