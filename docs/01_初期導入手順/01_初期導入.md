# `C:\dev\dolcos_calc` に **Rails×Docker(PostgreSQL) 開発環境**を一気に用意できる最小構成
（本プロジェクト方針：Rails 8 + Hotwire/Turbo、Importmap、**cssbundling-rails（Sass）**、Bootstrap 5.3.6、`docker compose` 経由で操作）

---

## 1) まず置くファイル一式

`C:\dev\dolcos_calc\Dockerfile`

```dockerfile
# アプリ用（Ruby 3.3 / Node + npm 同梱）
FROM ruby:3.3-slim

ENV LANG=C.UTF-8 TZ=Asia/Tokyo \
    BUNDLE_PATH=/usr/local/bundle \
    BUNDLE_JOBS=4 BUNDLE_RETRY=3 \
    PATH="/usr/local/bundle/bin:${PATH}"

# 必要パッケージ
RUN apt-get update -qq && apt-get install -y --no-install-recommends \
    build-essential libpq-dev curl git nodejs npm \
    pkg-config libyaml-dev \
  && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリ
WORKDIR /app

# 余談: Windows との改行差異対策（GitはLF推奨）
# RUN git config --global core.autocrlf input

# エントリポイント
COPY bin/entrypoint.sh /usr/bin/entrypoint.sh
# CRLF→LF に正規化し、実行権限を付与
RUN sed -i 's/\r$//' /usr/bin/entrypoint.sh && chmod +x /usr/bin/entrypoint.sh
ENTRYPOINT ["/usr/bin/entrypoint.sh"]

# ★ Rails と Bundler をグローバルに導入
RUN gem update --system -N \
 && gem install bundler -N \
 && gem install rails -v "~> 8.0" -N \
 && gem install foreman -N

# デフォルト起動（開発）
CMD ["bash", "-lc", "bin/dev"]
```

`C:\dev\dolcos_calc\docker-compose.yml`

```yaml
services:
  app:
    build: .
    image: dolcos_calc:dev
    container_name: dolcos_calc-app
    working_dir: /app
    volumes:
      - .:/app:cached
      - bundle-cache:/usr/local/bundle
      - node-cache:/app/node_modules
    ports:
      - "3000:3000"
    environment:
      RAILS_ENV: development
      NODE_ENV: development
      DATABASE_URL: postgres://postgres:postgres@db:5432/dolcos_calc_development
      # Windows でファイル監視を安定させるため:
      WEB_CONCURRENCY: "0"
      APP_HOST: localhost
      APP_PORT: "3000"
    depends_on:
      - db

  db:
    image: postgres:16
    container_name: dolcos_calc-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5433:5432" # ローカルから参照したい場合

volumes:
  bundle-cache:
  node-cache:
  pgdata:
```

`C:\dev\dolcos_calc\bin\entrypoint.sh`（**改行はLF**に！）

```bash
#!/usr/bin/env sh
set -e

# Rails の PID が残っていたら削除
rm -f tmp/pids/server.pid 2>/dev/null || true

exec "$@"
```

`.env` は今回は不要（composeに直書き）ですが、必要なら後で追加できます。

---

## 2) コンテナをビルド

```powershell
cd C:\dev\dolcos_calc
docker compose build
```

Rails が入ったか確認：

```powershell
docker compose run --rm --no-deps app rails -v
# → Rails 8.x.x が表示されればOK
```
---

## 3) DB設定（PostgreSQL／環境変数利用）

`config/database.yml` を下記のように修正：

```yaml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  url: <%= ENV.fetch(
          "DATABASE_URL",
          "postgres://postgres:postgres@db:5432/dolcos_calc_development"
        ) %>

test:
  <<: *default
  url: <%= ENV.fetch(
          "DATABASE_URL",
          "postgres://postgres:postgres@db:5432/dolcos_calc_test"
        ) %>

production:
  <<: *default
  url: <%= ENV.fetch("DATABASE_URL") {
          "postgres://#{ENV.fetch('POSTGRES_USER','postgres')}:#{ENV.fetch('POSTGRES_PASSWORD','postgres')}@db:5432/#{ENV.fetch('POSTGRES_DB','dolcos_calc_production')}"
        } %>
```

---
## 4) Rails アプリを中身つきで初期化

> まだ Rails プロジェクトを生成していない前提です（空フォルダからスタート）。  
> PowerShell は行継続の **バッククォート**が曲者なので、**一行**で打つのが無難です。

```powershell
docker compose run --no-deps app rails new . --force --skip-jbuilder --database=postgresql --css=sass --javascript=importmap
```

> 生成後、`Gemfile.lock` や `bin/dev` などが出来ます。  
> `rails new` のあとDockerfile が上書きされたら、  
 **「最初に作った Dockerfile/entrypoint.sh に戻す！！」** （`--force` を付けているので特に）

---

---
## 5) bin/devを編集（Rails標準でもOK／安定版ならこれ）
`bin\dev`
```sh
#!/usr/bin/env sh
set -e
export PATH="/usr/local/bundle/bin:$PATH"   # 念のため
exec /usr/local/bundle/bin/foreman start -f Procfile.dev
```

> Rails標準の「なければ gem install foreman する」版に戻してもOKですが、再現性重視なら**上の固定パス呼び出し**が安定。

---
## 6) Procfile.dev の web を 0.0.0.0 にバインド
`Procfile.dev`
```procfile
web: bin/rails server -b 0.0.0.0 -p 3000
css: npm run watch:css
```

---
## 7) 依存インストール & DB作成

```powershell
# 依存（Gem & npm）は rails new 時に概ね入りますが、念のため
docker compose run --rm app bundle install
docker compose run --rm app npm install
# sass を dev 依存として追加
docker compose run --rm app npm add -D sass
# DB作成
docker compose run --rm app rails db:create
```

---

## 8) Hotwire（Turbo/Stimulus）確認

Rails 8 + importmap では基本入っています。もし未導入なら：

```powershell
docker compose run --no-deps app rails turbo:install
docker compose run --no-deps app rails stimulus:install
```

> 本プロジェクト方針：**Rails UJS は使わない**（HotwireでOK）

---

## 9) Bootstrap 5.3.6（JSは Importmap／CSSは cssbundling-rails）

### 9-1) JS（Importmap でローカル ESM を pin）

`config/importmap.rb` に追記：

```ruby
pin "@popperjs/core", to: "/esm/@popperjs/core/index.js"
pin "bootstrap", to: "/esm/bootstrap/bootstrap.esm.js"
```

ローカルに ESM を配置します（npmから取り出して `public/esm` へコピー）：

```powershell
# 1) sass を dev 依存として追加
docker compose run --rm app npm add -D sass

# 2) Bootstrap を npm 依存に追加（CSSも使うので一石二鳥）
docker compose run --rm app npm add bootstrap@5.3.6

# 3) ESMファイルを公開パスへコピー
docker compose run -rm app bash -lc "mkdir -p public/esm/bootstrap && cp node_modules/bootstrap/dist/js/bootstrap.esm.js public/esm/bootstrap/bootstrap.esm.js"

# 4) @popperjs/coreも同様に
docker compose run --rm app npm add @popperjs/core@2.11.8
docker compose run --rm app bash -lc "mkdir -p public/esm/@popperjs/core && cp -r node_modules/@popperjs/core/dist/esm/* public/esm/@popperjs/core/"
# 5) bootstrap-iconsは追加のみ（ビルド時にコピーする）
docker compose run --rm app npm add bootstrap-icons@1.11.3
```

`app/javascript/application.js` で読み込み（必要なら）：

```js
import "bootstrap"
// すでに import "@hotwired/turbo-rails"; import "controllers" があるはず
```

### 9-2) CSS（cssbundling-rails / Sassで取り込み）

`app/assets/stylesheets/application.scss`に追記：

```scss
@use "bootstrap/scss/bootstrap";
```

`package.json` の `dependencies` に `bootstrap` が入っていれば `bin/dev` 起動で Sass ビルドされます。

### 9-3) `package.json` のスクリプト（Sass の node_modules 解決）
`package.json`
```json
{
  "scripts": {
    "copy:bi": "mkdir -p app/assets/builds/bootstrap-icons/fonts && cp node_modules/bootstrap-icons/font/bootstrap-icons.css app/assets/builds/bootstrap-icons/bootstrap-icons.css && cp node_modules/bootstrap-icons/font/fonts/* app/assets/builds/bootstrap-icons/fonts/",
    "build:css": "sass ./app/assets/stylesheets/application.scss:./app/assets/builds/application.css --no-source-map --load-path=node_modules && npm run copy:bi",
    "watch:css": "npm run copy:bi && sass --watch ./app/assets/stylesheets/application.scss:./app/assets/builds/application.css --load-path=node_modules"
  },
  "dependencies": {
    "@popperjs/core": "^2.11.8",
    "bootstrap": "^5.3.6",
    "bootstrap-icons": "^1.11.3"
  }
}
```
### 9-3) レイアウトで assets 経由の CSS を読む
`app\views\layouts\application.html.erb`
```html
<link rel="stylesheet" href="<%= asset_path('bootstrap-icons/bootstrap-icons.css') %>">
```
---

# 10) 開発起動

```powershell
docker compose up
```

* ブラウザで [http://localhost:3000](http://localhost:3000)
* エラー時はログ：`docker compose logs -f app`

---

# 11) 以後のコマンドは **docker compose 経由**

* モデル作成：
  `docker compose run --no-deps app rails g model RatePlan name:string`
* マイグレーション：
  `docker compose run --no-deps app rails db:migrate`
* コンソール：
  `docker compose run --no-deps app rails c`
* テスト：
  `docker compose run --no-deps app rails test`

> ※ Windows で `grep` が使えない場合は `findstr` を。  
> 例： `docker compose logs app | findstr /i error`
---

# 12) もしエラーが出たら
## 0) 困ったらまずこれ（安全リセット）

```powershell
# 停止＆残骸掃除（孤児も含めて）
docker compose down --remove-orphans

# 古い app/db コンテナが残っていれば一掃（任意）
docker ps -a --filter "name=dolcos_calc" -q | % { docker rm -f $_ }

# 実際に読み込まれているCompose設定の確認
docker compose config > .compose.effective.yml
# ← services: に不要な redis が居ないか等を確認

# ノーキャッシュ再ビルド
docker compose build --no-cache
```

## 1) `sass: not found`（CSSプロセスが127で即死）

**原因**: npmの`sass`未導入 / `node_modules`ボリュームの不整合  
**最短復旧**：

```powershell
docker compose down --remove-orphans

# node_modulesボリュームを作り直し（名前を確認して置換）
docker volume ls | findstr node-cache
docker volume rm dolcos_calc_node-cache

# 入れ直し
docker compose run --rm app npm install
docker compose run --rm app npm add -D sass
docker compose run --rm app npm add bootstrap@5.3.6
docker compose run --rm app bash -lc "mkdir -p app/assets/builds"

docker compose up
```
---
## 2) `rails db:create` / `db:prepare` が `could not translate host name "db"` で失敗

**原因**: `--no-deps`で起動し、DBサービスが上がっていない  
**対処**:

```powershell
# DBを先に常駐起動
docker compose up -d db

# それでもダメならDNS確認
docker compose run --rm --no-deps app getent hosts db

# 接続確認（パスワード: postgres）
docker compose run --rm --no-deps app bash -lc "PGPASSWORD=postgres psql -h db -U postgres -c 'select 1'"

# その後にDB作成
docker compose run --rm --no-deps app rails db:create
```

---
## 3) `bin/docker-entrypoint` と自前 `entrypoint.sh` の衝突

**症状**: 期待と違うエントリポイントが動く/CRLFで`bash\r`エラー
**対処**:

* `rails new` 後に Rails標準の Dockerfile/entrypoint が **上書き生成** されることがある。必要なら自前のものを戻す。
* 自前 `entrypoint.sh`（LFで保存）：

  ```sh
  #!/usr/bin/env sh
  set -e
  rm -f tmp/pids/server.pid 2>/dev/null || true
  exec "$@"
  ```
* Dockerfile で CRLF→LF 正規化：

  ```dockerfile
  COPY bin/entrypoint.sh /usr/bin/entrypoint.sh
  RUN sed -i 's/\r$//' /usr/bin/entrypoint.sh && chmod +x /usr/bin/entrypoint.sh
  ENTRYPOINT ["/usr/bin/entrypoint.sh"]
  ```

---

## 4) Redis が勝手に起動する / 消したのに残る

**原因**: `docker-compose.override.yml` 等でredisがマージされている / 旧コンテナが残骸  
**対処**:

```powershell
docker compose down --remove-orphans

# どのファイルに残ってるか確認
Get-ChildItem -File -Filter "docker-compose*.yml","docker-compose*.yaml"
Select-String -Path "docker-compose*.y*" -Pattern "redis" -SimpleMatch

# 有効設定を確認
docker compose config > .compose.effective.yml
# ← services: から redis等 が消えているのを確認

# それでも残る停止中コンテナは手動削除（例：redis）
docker ps -a --filter "name=dolcos_calc-redis" -q | % { docker rm -f $_ }
```

---
## 5) “最短で復帰” コマンドセット（コピペ用）

```powershell
cd C:\dev\dolcos_calc
docker compose down --remove-orphans
docker compose config > .compose.effective.yml

# npm系リセットが必要そうなら（sass not found等）
docker volume rm dolcos_calc_node-cache  # ←名前は環境に合わせて
docker compose run --rm app npm install
docker compose run --rm app npm add -D sass
docker compose run --rm app npm add bootstrap@5.3.6
docker compose run --rm app bash -lc "mkdir -p app/assets/builds"

docker compose build --no-cache
docker compose up -d db
docker compose run --rm --no-deps app rails db:prepare
docker compose up
```

---