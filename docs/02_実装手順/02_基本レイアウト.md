# 基本レイアウトの導入

`app\views\workspaces` に基本レイアウトを組み、以後、 `<%= turbo_frame_tag "main" do %>` 内で遷移させます。

* `app\assets\stylesheets\application.scss`

    ```scss
    @use "bootstrap/scss/bootstrap" as *;
    @use "components/pages";
    @use "components/workspaces";
    ```

* `app\assets\stylesheets\components\workspaces.scss`

    ``` scss
    /* XL 以上で “カラム独立スクロール & サイドバー静的化” */
    @media (min-width: 1200px) {
      /* 1) body をスクロールさせない */
      html, body { height: 100%; }
      body { overflow: hidden; }

      /* 2) ヘッダー直下のラッパはビューポート高 - ヘッダー高で固定 */
      .app-shell {
        min-height: calc(100dvh - var(--app-header-h, 56px));
        height:     calc(100dvh - var(--app-header-h, 56px));
        overflow: hidden; /* ここではスクロールさせない */
      }

      /* 3) 各カラムが自前でスクロール（＝貼り付き） */
      .app-col {
        height: 100%;
        overflow: auto;
        overscroll-behavior: contain;
      }

      /* 4) サイドバーを静的化（offcanvas解除） */
      #appSidebar.offcanvas-xl {
        position: static;
        transform: none !important;
        visibility: visible !important;
        display: block !important;
        width: var(--bs-offcanvas-width, 260px);
        flex: 0 0 var(--bs-offcanvas-width, 260px);
        z-index: auto;
      }
      #appSidebar .offcanvas-header { display: none !important; }
    }
    @media (min-width: 1400px) {
      .app-ads-col { width: 280px; flex: 0 0 280px; }
    }
    ```

* `app\views\workspaces\show.html.erb`

    ```erb
    <header id="appHeader" class="navbar bg-body border-bottom sticky-top">
      <div class="container-fluid d-flex align-items-center gap-2">

        <!-- 左: ハンバーガー（XL未満のみ表示） -->
        <button class="btn btn-outline-secondary d-xl-none"
                type="button"
                data-bs-toggle="offcanvas"
                data-bs-target="#appSidebar"
                aria-controls="appSidebar"
                aria-label="メニューを開く">
          <i class="bi bi-list" aria-hidden="true"></i>
        </button>

        <!-- 中央: サイトタイトル（xsは中央寄せ＆トランケート、sm以上は左寄せ） -->
        <%= link_to "ドルコス年利計算機", dummy_path,
                    class: "navbar-brand flex-grow-1 text-truncate text-center text-sm-start m-0",
                    data: { turbo_frame: "main" } %>

        <!-- 右: ユーザードロップダウン（xsはアイコンのみ、md以上でメール表示） -->
        <div class="dropdown">
          <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center"
                  type="button" data-bs-toggle="dropdown" aria-expanded="false"
                  aria-label="<%= current_user.guest? ? 'ゲストメニュー' : 'ユーザーメニュー' %>">
            <i class="bi bi-person-circle" aria-hidden="true"></i>
            <span class="d-none d-md-inline ms-2 text-truncate" style="max-width: 28ch;">
              <% if current_user.guest? %>
                ゲスト
              <% else %>
                <%= current_user.email %>
              <% end %>
            </span>

          </button>

          <ul class="dropdown-menu dropdown-menu-end">
            <% if current_user.guest? %>
              <!-- ゲスト用：設定は省略or読み取り専用にするならリンクなしでもOK -->
              <li>
                <%= link_to destroy_user_session_path(redirect: "sign_in"),
                            data: { turbo_method: :delete, turbo_frame: "_top",
                                    turbo_confirm: "ゲストを終了してログイン画面へ進みます。よろしいですか？" },
                            class: "dropdown-item" do %>
                  <i class="bi bi-arrow-left-right me-2"></i> ログイン
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <%= link_to destroy_user_session_path(redirect: "sign_up"),
                            class: "dropdown-item",
                            data: { turbo_method: :delete, turbo_frame: "_top",
                                    turbo_confirm: "ゲストを終了して新規登録画面へ進みます。よろしいですか？" } do %>
                  <i class="bi bi-person-plus me-2"></i> 新規登録
                <% end %>
              </li>
            <% else %>
              <li>
                <%= link_to dummy_path,
                            class: "dropdown-item", data: { turbo_frame: "main" } do %>
                  <i class="bi bi-gear me-2"></i> 設定
                <% end %>
              </li>
              <li>
                <%= link_to destroy_user_session_path(redirect: "sign_in"),
                            data: { turbo_method: :delete, turbo_frame: "_top",
                                    turbo_confirm: "ユーザーを切り替えます。よろしいですか？" },
                            class: "dropdown-item" do %>
                  <i class="bi bi-arrow-left-right me-2"></i> ユーザーを切り替える
                <% end %>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <%= link_to destroy_user_session_path,
                            data: { turbo_method: :delete, turbo_frame: "_top",
                                    turbo_confirm: "ログアウトしますか？" },
                            class: "dropdown-item text-danger" do %>
                  <i class="bi bi-box-arrow-right me-2"></i> ログアウト
                <% end %>
              </li>
            <% end %>
          </ul>
        </div>

      </div>
    </header>

    <div class="container-fluid">
      <!-- ★ ヘッダー直下のラッパ。XL以上は固定高＆内部だけスクロール -->
      <div class="app-shell d-xl-flex">

        <nav id="appSidebar"
            class="offcanvas offcanvas-start offcanvas-xl border-end app-col"
            tabindex="-1"
            aria-labelledby="appSidebarLabel"
            style="--bs-offcanvas-width: 260px;">
          <div class="offcanvas-header d-xl-none d-flex align-items-center gap-2">
            <h5 class="offcanvas-title flex-grow-1 mb-0 text-truncate" id="appSidebarLabel">メニュー</h5>
            <button type="button" class="btn btn-outline-secondary ms-auto" data-bs-dismiss="offcanvas" aria-label="閉じる">
              <i class="bi bi-list" aria-hidden="true"></i>
            </button>
          </div>
          <!-- ★ ここは app-col が高さ100%を持つので h-100 を付けておくと安定 -->
          <div class="offcanvas-body p-0 h-100">
            <%= render "workspaces/sidebar" %>
          </div>
        </nav>

        <main class="flex-grow-1 py-3 app-col">
          <%= turbo_frame_tag "main", src: dummy_path, loading: "lazy" do %>
            <div class="p-3 text-muted">読み込み中...</div>
          <% end %>
        </main>

        <aside class="d-none d-xxl-block border-start py-3 app-col" style="width: 280px;">
          <div class="card">
            <div class="card-body">
              <div class="text-muted">広告スペース（XXL以上で表示）</div>
              <div class="ratio ratio-1x1 mt-2 border rounded"></div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- ヘッダー高さを CSS 変数に反映（レスポンシブ対応） -->
    <script type="module">
      const setHeaderVar = () => {
        const h = document.getElementById("appHeader")?.offsetHeight || 56;
        document.documentElement.style.setProperty("--app-header-h", `${h}px`);
      };
      addEventListener("resize", setHeaderVar);
      addEventListener("turbo:load", setHeaderVar);
      document.readyState === "loading" ? addEventListener("DOMContentLoaded", setHeaderVar) : setHeaderVar();
    </script>
    ```

* `app\views\workspaces\_sidebar.html.erb`

    ```erb
    <ul class="list-group list-group-flush">
      <% menu = [
        { path: ->{ dummy_path }, icon: "calculator",   label: "積立計算",     roles: [:member, :admin, :guest], turbo: true },
        { path: ->{ dummy_path }, icon: "filetype-py",  label: "Pythonテスト", roles: [:admin],                  turbo: true },
        { path: ->{ dummy_path }, icon: "journal-text", label: "お知らせ",     roles: [:member, :admin],         turbo: true },
        { path: ->{ dummy_path }, icon: "shield-lock",  label: "管理",         roles: [:admin],                  turbo: true }
      ] %>

      <% roles_now =
          if current_user&.guest?
            [:guest]
          elsif current_user&.admin?
            [:admin]
          else
            [:member]
          end %>

      <% menu.each do |item| %>
        <% next unless (item[:roles] & roles_now).any? %>
        <% link_opts = item[:turbo] ? { data:{ turbo_frame:"main"} } : {} %>
        <li class="list-group-item">
          <%= link_to item[:path].call, { class:"mb-2 link-offset-2 link-offset-3-hover link-underline link-underline-opacity-0 link-underline-opacity-75-hover" }.merge(link_opts) do %>
            <i class="bi bi-<%= item[:icon] %> fs-4" aria-label="<%= item[:label] %>"></i>
            <span class="ms-3"><%= item[:label] %></span>
          <% end %>
        </li>
      <% end %>
    </ul>
    ```
    **目的**
    * メニュー構成を配列で宣言し、**表示ロジックを1か所に集約**する
    * `current_user.guest?` および `current_user.admin?` を使って**出し分け**
    * Turbo Frames（`data-turbo-frame="main"`）と**相性良く遷移**させる

    **使い方**
    * `path:` は **ラムダ（`-> { ... }`）** にして、テンプレート評価時にルートヘルパを呼び出す
    * `icon:` は **Bootstrap Icons** のクラス（`bi-<name>`）末尾部分
    * `roles:` は **表示対象ロールの配列**
        * **管理者のみ**表示したい → `roles: [:admin]`
        * **会員＋管理者** → `roles: [:member, :admin]`
        * **全員（ゲスト含む）** → `roles: [:member, :admin, :guest]`
    * `turbo:` が `true` のとき **`data-turbo-frame="main"`** を付与

    **外部リンクを追加する**

    * `turbo: false` にして Turbo Frame を無効化（外部は通常リンクで開く）

        ```erb
        { path: ->{ "https://example.com/docs" }, icon: "book", label: "ドキュメント", roles: [:member, :admin], turbo: false }
        ```

    **コントローラー実装時の注意**

    1. **可視制御 ≠ 権限制御**
        このサイドバーは**見た目の出し分け**です。**サーバー側の認可（Authorization）は別途必須**。

        * 例: `before_action :authenticate_user!` を基本に、管理画面は `return head :forbidden unless current_user&.admin?` などでガード
        * 将来 Pundit/CanCanCan に切り替える場合も、**コントローラー側で権限チェック**すること

    2. **Turbo Frames の前提**

        * メイン域に `<turbo-frame id="main">` が存在すること
        * `turbo: true` のリンク先は **部分テンプレート or ページの main 区画**のみ描画する設計にすると体験が良い
        * **リダイレクト時**、Turbo Frame のまま返したい場合は `turbo_frame_request?` を考慮したレスポンスにする

    3. **ルーティングの安定性**

        * `path:` のラムダ内で用いる**ルートヘルパが存在する**こと
        * パスにパラメータが必要な場合は、**引数付き**で書く（例: `-> { user_path(current_user) }`）

    4. **`current_user` の存在**

        * 未認証アクセスを許すページでサイドバーを出す場合、`current_user` が `nil` の可能性あり
        * 本テンプレートは `current_user&.xxx` で **nil セーフ**になっている前提

    5. **N+1/重い処理を避ける**

        * サイドバーは**全ページで描画**されがち。`menu` 配列は**定数・軽量**を意識
        * DBを叩く判定は書かない（`admin?` は env リスト判定のみ）
