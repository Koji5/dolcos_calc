# 本番運用チェックリスト

## 1) インフラ／ネットワーク

* 運用する **ドメイン** を確定（例：`app.example.com`）。
* **DNS**（Route53 など）で公開。ALB を使うなら A/AAAA を ALB に向ける。
* **HTTPS 終端**：ALB もしくはNginxで TLS 終端。証明書は ACM 等で発行・更新自動化。
* **セキュリティグループ/Firewall**：80/443 のみ公開、DB 等はプライベートに限定。

## 2) データベース

* 本番 DB（RDS 等）を用意（文字コード/タイムゾーン/バックアップ保持）。
* 自動バックアップ・スナップショット・監視（CPU/I/O/接続数/ストレージ残量）を有効化。
* アプリ用 DB ユーザーを発行（最小権限）。

## 3) ストレージ（Active Storage が :amazon の場合）

* **S3 バケット**を本番用に作成（リージョン、暗号化、バージョニング有無）。
* **IAM ポリシー**：最小権限で S3 への読み書き許可を付与。
* 必要なら **CDN（CloudFront）** 設計（画像配信最適化、署名付きURL方針）。

## 4) メール送信（Confirmable/Recoverable 用）

* 送信元アドレス（From）を決める（`no-reply@...` 推奨）。
* 本番 SMTP（SES / SendGrid 等）を選定し、**SPF/DKIM/DMARC** を設定。
* 送信レート・バウンス監視・サプレッション（届かない宛先抑止）を整備。
* アプリの既定リンク（ホスト名）と整合（確認メール内 URL が本番ドメインで開く）。

## 5) Rails/Devise の本番設定

* **アプリのホスト許可**（Host Authorization）に本番ドメインを追加。
* **デフォルト URL オプション**（Mailer/ルーティング）に本番ホストを設定。
* **Force SSL**（アプリ側/ALB 側いずれかで強制）。
* **セッション/Cookie**：`secure`・`same_site`・`domain`（サブドメイン運用なら要設計）。
* **環境変数/シークレット**：`SECRET_KEY_BASE`、メール認証情報、S3/IAM、DB 接続情報。
* **Devise**

  * `confirmable` 有効・メール再送挙動の確認。
  * `rememberable` の期限ポリシーを決める（記憶期間/解除条件）。
  * `recoverable` のレート制限（後述のWAF/Recaptcha等と合わせて検討）。
  * `trackable` のログ活用（監査/不正検知に使うなら可視化先を検討）。

## 6) ログイン後ダミーページ

* 認証済みユーザーの遷移先（ダミー画面）を本番でも表示確認。
* 未ログイン時のトップとの分岐（導線/エラーハンドリング/フラッシュ表示方針）。

## 7) セキュリティ強化

* **WAF/Rate Limit**：ログイン/パスワード再設定/サインアップの機械的な連打対策。
* **reCAPTCHA**（サインアップ/パスワード再設定に検討）。
* **CSRF/Origin-Check** の有効化を確認（デフォルト整合）。
* **ログイン試行監視**（IP/回数の可視化。Trackable と突合）。
* **依存ライブラリの脆弱性監視**（定期アップデート方針）。

## 8) パフォーマンス/運用

* **Puma スレッド/ワーカー数**の計画（メモリ予算と同時接続のバランス）。
* アセット・CSS の **ビルド/配信設計**（Importmap + cssbundling 前提でのキャッシュ戦略）。
* **ログローテーション**・ログ出力先（CloudWatch Logs 等）・PII 取り扱い方針。
* **エラートラッキング**（Sentry など）と通知（Slack/メール）。
* **ヘルスチェック**（ALB/コンテナ監視）と **再起動ポリシー**。
* **時刻/タイムゾーン**（アプリ/DB/OS の整合）とジョブの時間基準。
* **ジョブキュー**：メール送信を非同期化するならワーカー導入（最小構成なら同期でも可、将来 Sidekiq 等）。

## 9) デプロイ前後のデータ整合

* 本番用マイグレーションの実行順序・ロールバック方針を決める。
* 既存データがない前提でも、**初期ユーザー**作成方法（手動/招待）を決める。
* Confirmable 有効時の **既存ユーザーの confirmed 状態**（将来の移行時のための運用ルール）。

## 10) 監視/アラート

* **アプリ監視**：応答時間/エラー率/5xx 監視。
* **インフラ監視**：CPU/メモリ/ディスク/ネットワーク/ALB 5xx。
* **DB 監視**：接続数/スロークエリ/ロック。
* **アラート閾値** と通知先（オンコール/Slack/メール）。

## 11) 運用ルール/手順

* **デプロイ手順**：ビルド → マイグレーション → 切替 → ヘルス確認（ローリング/停止有無）。
* **ロールバック手順**：バージョン固定/イメージ差し戻し/DB 変更の扱い（後方互換を基本に）。
* **障害対応フロー**：誰が/どこで/どう判断するか（連絡網・初動チェックリスト）。
* **バックアップ/復旧訓練**：DB・S3 の **定期バックアップ** と **復元テスト** をスケジュール化。

## 12) 法務/利用規約（必要に応じて）

* サインアップに伴う **利用規約/プライバシーポリシー** の提示導線。
* メール通知（確認/再設定）に関する文面・表現の最終確認（表記ゆれ/会社情報の記載）。

---

### 最小で必ず詰めるべき「コア」

1. 本番ドメイン + HTTPS
2. 本番 DB + バックアップ
3. メール送信（SPF/DKIM）+ 本番ホストの URL 生成
4. SECRET_KEY_BASE など **シークレット安全管理**
5. Force SSL / Cookie セキュア化 / Host 許可
6. 初回ユーザーのオンボーディング（Confirmable の動線確認）
7. マイグレーションとログイン後ダミー画面の実機確認

このリストをベースに、実際の環境（EC2/ALB/S3/RDS/SES の有無など）に合わせて具体化していけば、Devise 最小構成を安全に本番へ持っていけます。  
必要なら各項目をあなたの現在の構成（`docker-compose.prod.yml`、ALB 有無、S3/IAM 設計 など）に合わせて **運用Runbook** 化します。
